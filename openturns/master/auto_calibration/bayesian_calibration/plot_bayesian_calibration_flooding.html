
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bayesian calibration of the flooding model &#8212; OpenTURNS 1.16dev documentation</title>
    <link rel="stylesheet" href="../../_static/openturns.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gallery-dataframe.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../_static/js/mysearchtools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Numerical methods" href="../../auto_numerical_methods/index.html" />
    <link rel="prev" title="Bayesian calibration of a computer code" href="plot_bayesian_calibration.html" />
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400,700'
          rel='stylesheet' type='text/css' />
 

  </head><body>
<div class="pageheader">
  <ul>
    <li><a href="http://www.openturns.org/">Home</a></li>
    <li><a href="../../install.html">Get it</a></li>
    <li><a href="../../contents.html">Doc</a></li>
    <li><a href="https://gitter.im/openturns/community">Chat</a></li>
    <li><a href="https://github.com/openturns">Code</a></li>
    <li><a href="https://github.com/openturns/openturns/issues">Bugs</a></li>
  </ul>
  <a href="../../index.html">
    <h1>
      <img src="../../_static/logo-openturns-wo-bg.png" alt="" width=100px height=100px />
      OpenTURNS
    </h1>
    <h2> An Open source initiative for the Treatment of Uncertainties, Risks'N Statistics</h2>
  </a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../auto_numerical_methods/index.html" title="Numerical methods"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="plot_bayesian_calibration.html" title="Bayesian calibration of a computer code"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">OpenTURNS 1.16dev documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../contents.html" >Contents</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../examples/examples.html" >Examples</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../index.html" accesskey="U">Calibration</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Bayesian calibration of the flooding model</a></li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Bayesian calibration of the flooding model</a><ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#model">Model</a></li>
<li><a class="reference internal" href="#parameters">Parameters</a></li>
<li><a class="reference internal" href="#outputs">Outputs</a></li>
<li><a class="reference internal" href="#distribution">Distribution</a></li>
<li><a class="reference internal" href="#parameters-to-calibrate">Parameters to calibrate</a></li>
<li><a class="reference internal" href="#observations">Observations</a></li>
<li><a class="reference internal" href="#analysis">Analysis</a></li>
<li><a class="reference internal" href="#generate-the-observations">Generate the observations</a></li>
<li><a class="reference internal" href="#setting-the-calibration-parameters">Setting the calibration parameters</a></li>
<li><a class="reference internal" href="#test-the-mcmc-sampler">Test the MCMC sampler</a></li>
<li><a class="reference internal" href="#test-the-metropolis-hastings-sampler">Test the Metropolis-Hastings sampler</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="plot_bayesian_calibration.html"
                        title="previous chapter">Bayesian calibration of a computer code</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../../auto_numerical_methods/index.html"
                        title="next chapter">Numerical methods</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/auto_calibration/bayesian_calibration/plot_bayesian_calibration_flooding.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-auto-calibration-bayesian-calibration-plot-bayesian-calibration-flooding-py"><span class="std std-ref">here</span></a>     to download the full example code</p>
</div>
<div class="sphx-glr-example-title section" id="bayesian-calibration-of-the-flooding-model">
<span id="sphx-glr-auto-calibration-bayesian-calibration-plot-bayesian-calibration-flooding-py"></span><h1>Bayesian calibration of the flooding model<a class="headerlink" href="#bayesian-calibration-of-the-flooding-model" title="Permalink to this headline">¶</a></h1>
<div class="section" id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Permalink to this headline">¶</a></h2>
<p>The goal of this example is to present the statistical hypotheses of the bayesian calibration of the flooding model.</p>
</div>
<div class="section" id="model">
<h2>Model<a class="headerlink" href="#model" title="Permalink to this headline">¶</a></h2>
<p>The simulator predicts the water height H depending on the flowrate Q.</p>
<p>We consider the following four variable:</p>
<ul class="simple">
<li><p>Q : the river flowrate (<img class="math" src="../../_images/math/a393fed70c42d3721c10a035e16c64afcf91862d.svg" alt="m^3/s"/>)</p></li>
<li><p>Ks : the Strickler coefficient (<img class="math" src="../../_images/math/c96cd48af49655c08d64e308df6d6b0b3307a112.svg" alt="m^{1/3}/s"/>)</p></li>
<li><p>Zv : the downstream riverbed level (m)</p></li>
<li><p>Zm : the upstream riverbed level (m)</p></li>
</ul>
<p>When the Strickler coefficient increases, the riverbed generates less friction to the water flow.</p>
</div>
<div class="section" id="parameters">
<h2>Parameters<a class="headerlink" href="#parameters" title="Permalink to this headline">¶</a></h2>
<p>We consider the following parameters:</p>
<ul class="simple">
<li><p>the length of the river L = 5000 (m),</p></li>
<li><p>the width of the river B = 300 (m).</p></li>
</ul>
</div>
<div class="section" id="outputs">
<h2>Outputs<a class="headerlink" href="#outputs" title="Permalink to this headline">¶</a></h2>
<p>We make the hypothesis that the slope of the river is nonpositive and close to zero, which implies:</p>
<div class="math">
<p><img src="../../_images/math/c15ee300674fbf606cac2a3ada32ad1d07ed5ce3.svg" alt="\alpha = \frac{Z_m - Z_v}{L},"/></p>
</div><p>if <img class="math" src="../../_images/math/e904c8df7c79f25a6339c043fa4376d8aaa94361.svg" alt="Z_m \geq Z_v"/>.
The height of the river is:</p>
<div class="math">
<p><img src="../../_images/math/c3534994f7f402b7ec246586b28e11f8bb7da66d.svg" alt="H = \left(\frac{Q}{K_s B \sqrt{\alpha}}\right)^{0.6},"/></p>
</div><p>for any <img class="math" src="../../_images/math/576c0512a2a89645e0a9914bf806339b8da2eaa9.svg" alt="K_s, Q&gt;0"/>.</p>
</div>
<div class="section" id="distribution">
<h2>Distribution<a class="headerlink" href="#distribution" title="Permalink to this headline">¶</a></h2>
<p>We assume that the river flowrate has the following truncated Gumbel distribution:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 22%" />
<col style="width: 78%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Variable</p></th>
<th class="head"><p>Distribution</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Q</p></td>
<td><p>Gumbel(scale=558, mode=1013)&gt;0</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="parameters-to-calibrate">
<h2>Parameters to calibrate<a class="headerlink" href="#parameters-to-calibrate" title="Permalink to this headline">¶</a></h2>
<p>The vector of parameters to calibrate is:</p>
<div class="math">
<p><img src="../../_images/math/4f50c771bbc0d71095d2ff28da7d58b1f321de96.svg" alt="\theta = (K_s,Z_v,Z_m)."/></p>
</div><p>The variables to calibrate are <img class="math" src="../../_images/math/5455f33bcd018707f895c19d1c6cf12ec363bb15.svg" alt="(K_s,Z_v,Z_m)"/> and are set to the following values:</p>
<div class="math">
<p><img src="../../_images/math/46f627387990a5c60fdc213ddd9e9b5807b6f99c.svg" alt="K_s = 30, \qquad Z_v = 50, \qquad Z_m = 55."/></p>
</div></div>
<div class="section" id="observations">
<h2>Observations<a class="headerlink" href="#observations" title="Permalink to this headline">¶</a></h2>
<p>In this section, we describe the statistical model associated with the <img class="math" src="../../_images/math/80b394abd4fb264a3879675f92f191c3e346c3a0.svg" alt="n"/> observations.
The errors of the water heights are associated with a gaussian distribution with a zero mean and a standard variation equal to:</p>
<div class="math">
<p><img src="../../_images/math/cc9e07440dff8a3cd441a1ba96af3f321a65f0fd.svg" alt="\sigma=0.1."/></p>
</div><p>Therefore, the observed water heights are:</p>
<div class="math">
<p><img src="../../_images/math/ef52700b2aa7521f3618b931a1fc78f20cbdebee.svg" alt="H_i = G(Q_i,K_s,Z_v,Z_m) + \epsilon_i"/></p>
</div><p>for <img class="math" src="../../_images/math/f547f9b5b4447a6ea60f75e19838225adb8f96e6.svg" alt="i=1,...,n"/> where</p>
<div class="math">
<p><img src="../../_images/math/b1c6973c9d4195a7c89bea351395a4e888af56e3.svg" alt="\epsilon \sim \mathcal{N}(0,\sigma^2)"/></p>
</div><p>and we make the hypothesis that the observation errors are independent.
We consider a sample size equal to:</p>
<div class="math">
<p><img src="../../_images/math/6a0219debc9dc5425d64c03a6e764e40db06629f.svg" alt="n=20."/></p>
</div><p>The observations are the couples <img class="math" src="../../_images/math/3423cbb5a9a8ebd38fe77deb2b6305937fdc12d2.svg" alt="\{(Q_i,H_i)\}_{i=1,...,n}"/>, i.e. each observation is a couple made of the flowrate and the corresponding river height.</p>
</div>
<div class="section" id="analysis">
<h2>Analysis<a class="headerlink" href="#analysis" title="Permalink to this headline">¶</a></h2>
<p>In this model, the variables <img class="math" src="../../_images/math/297121d3454c7810542417c95f368e09e5bbdd7c.svg" alt="Z_m"/> and <img class="math" src="../../_images/math/8c65111b411d8acc67c23f70a96820c191e76c60.svg" alt="Z_v"/> are not identifiables, since only the difference <img class="math" src="../../_images/math/9999c7bca80e36bd32d0ecd9475b8562e3ff7c32.svg" alt="Z_m-Z_v"/> matters. Hence, calibrating this model requires some regularization.</p>
</div>
<div class="section" id="generate-the-observations">
<h2>Generate the observations<a class="headerlink" href="#generate-the-observations" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">openturns</span> <span class="k">as</span> <span class="nn">ot</span>
<span class="n">ot</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">Show</span><span class="p">(</span><span class="n">ot</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">NONE</span><span class="p">)</span>
</pre></div>
</div>
<p>We define the model <img class="math" src="../../_images/math/658ae44ee69111e3048325f416f44d6080707928.svg" alt="g"/> which has 4 inputs and one output H.</p>
<p>The nonlinear least squares does not take into account for bounds in the parameters. Therefore, we ensure that the output is computed whatever the inputs. The model fails into two situations:</p>
<ul class="simple">
<li><p>if <img class="math" src="../../_images/math/5368b407d069b73d44d092748eee55867992e987.svg" alt="K_s&lt;0"/>,</p></li>
<li><p>if <img class="math" src="../../_images/math/747754aa15335a1c45edd090361530371d3f0e21.svg" alt="Z_v-Z_m&lt;0"/>.</p></li>
</ul>
<p>In these cases, we return an infinite number.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">functionFlooding</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">L</span> <span class="o">=</span> <span class="mf">5.0e3</span>
    <span class="n">B</span> <span class="o">=</span> <span class="mf">300.0</span>
    <span class="n">Q</span><span class="p">,</span> <span class="n">K_s</span><span class="p">,</span> <span class="n">Z_v</span><span class="p">,</span> <span class="n">Z_m</span> <span class="o">=</span> <span class="n">X</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">Z_m</span> <span class="o">-</span> <span class="n">Z_v</span><span class="p">)</span><span class="o">/</span><span class="n">L</span>
    <span class="k">if</span> <span class="n">alpha</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">K_s</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="n">Q</span><span class="o">/</span><span class="p">(</span><span class="n">K_s</span><span class="o">*</span><span class="n">B</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">alpha</span><span class="p">)))</span><span class="o">**</span><span class="p">(</span><span class="mf">3.0</span><span class="o">/</span><span class="mf">5.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">H</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">PythonFunction</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">functionFlooding</span><span class="p">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">MemoizeFunction</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">setOutputDescription</span><span class="p">([</span><span class="s2">&quot;H (m)&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>Create the input distribution for <img class="math" src="../../_images/math/2e719bfa618fbb4fc4698366967a264fbba46dd4.svg" alt="Q"/>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Q</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Gumbel</span><span class="p">(</span><span class="mf">558.0</span><span class="p">,</span> <span class="mf">1013.0</span><span class="p">)</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">TruncatedDistribution</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">ot</span><span class="o">.</span><span class="n">TruncatedDistribution</span><span class="o">.</span><span class="n">LOWER</span><span class="p">)</span>
<span class="n">Q</span><span class="o">.</span><span class="n">setDescription</span><span class="p">([</span><span class="s2">&quot;Q (m3/s)&quot;</span><span class="p">])</span>
<span class="n">Q</span>
</pre></div>
</div>
<p>TruncatedDistribution(Gumbel(beta = 558, gamma = 1013), bounds = [0, (19000.8) +inf[)</p>
<br />
<br /><p>Set the parameters to be calibrated.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">K_s</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Dirac</span><span class="p">(</span><span class="mf">30.0</span><span class="p">)</span>
<span class="n">Z_v</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Dirac</span><span class="p">(</span><span class="mf">50.0</span><span class="p">)</span>
<span class="n">Z_m</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Dirac</span><span class="p">(</span><span class="mf">55.0</span><span class="p">)</span>
<span class="n">K_s</span><span class="o">.</span><span class="n">setDescription</span><span class="p">([</span><span class="s2">&quot;Ks (m^(1/3)/s)&quot;</span><span class="p">])</span>
<span class="n">Z_v</span><span class="o">.</span><span class="n">setDescription</span><span class="p">([</span><span class="s2">&quot;Zv (m)&quot;</span><span class="p">])</span>
<span class="n">Z_m</span><span class="o">.</span><span class="n">setDescription</span><span class="p">([</span><span class="s2">&quot;Zm (m)&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>Create the joint input distribution.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">inputRandomVector</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">ComposedDistribution</span><span class="p">([</span><span class="n">Q</span><span class="p">,</span> <span class="n">K_s</span><span class="p">,</span> <span class="n">Z_v</span><span class="p">,</span> <span class="n">Z_m</span><span class="p">])</span>
</pre></div>
</div>
<p>Create a Monte-Carlo sample of the output H.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nbobs</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">inputSample</span> <span class="o">=</span> <span class="n">inputRandomVector</span><span class="o">.</span><span class="n">getSample</span><span class="p">(</span><span class="n">nbobs</span><span class="p">)</span>
<span class="n">outputH</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">inputSample</span><span class="p">)</span>
</pre></div>
</div>
<p>Generate the observation noise and add it to the output of the model.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sigmaObservationNoiseH</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1"># (m)</span>
<span class="n">noiseH</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="n">sigmaObservationNoiseH</span><span class="p">)</span>
<span class="n">ot</span><span class="o">.</span><span class="n">RandomGenerator</span><span class="o">.</span><span class="n">SetSeed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">sampleNoiseH</span> <span class="o">=</span> <span class="n">noiseH</span><span class="o">.</span><span class="n">getSample</span><span class="p">(</span><span class="n">nbobs</span><span class="p">)</span>
<span class="n">Hobs</span> <span class="o">=</span> <span class="n">outputH</span> <span class="o">+</span> <span class="n">sampleNoiseH</span>
</pre></div>
</div>
<p>Plot the Y observations versus the X observations.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Qobs</span> <span class="o">=</span> <span class="n">inputSample</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">graph</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="s2">&quot;Observations&quot;</span><span class="p">,</span><span class="s2">&quot;Q (m3/s)&quot;</span><span class="p">,</span><span class="s2">&quot;H (m)&quot;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cloud</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Cloud</span><span class="p">(</span><span class="n">Qobs</span><span class="p">,</span><span class="n">Hobs</span><span class="p">)</span>
<span class="n">graph</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cloud</span><span class="p">)</span>
<span class="n">graph</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>class=Graph name=Observations implementation=class=GraphImplementation name=Observations title=Observations xTitle=Q (m3/s) yTitle=H (m) axes=ON grid=ON legendposition= legendFontSize=1 drawables=[class=Drawable name=Unnamed implementation=class=Cloud name=Unnamed derived from class=DrawableImplementation name=Unnamed legend= data=class=Sample name=Unnamed implementation=class=SampleImplementation name=Unnamed size=20 dimension=2 data=[[2752.94,3.96323],[591.629,1.42464],[2096.19,3.26988],[1063.75,2.32631],[1435.35,2.42201],[1180.75,2.38328],[2096.39,3.27839],[1118.34,2.41672],[759.955,1.88378],[527.619,1.52758],[2224.3,3.38672],[595.185,1.58295],[708.427,1.49934],[1192.74,2.23426],[552.293,1.35735],[2148.86,3.35433],[792.987,1.94891],[1322.54,2.49967],[541.825,1.41551],[1219.52,2.43879]] color=blue fillStyle=solid lineStyle=solid pointStyle=plus lineWidth=1]
</pre></div>
</div>
</div>
<div class="section" id="setting-the-calibration-parameters">
<h2>Setting the calibration parameters<a class="headerlink" href="#setting-the-calibration-parameters" title="Permalink to this headline">¶</a></h2>
<p>Define the parametric model <img class="math" src="../../_images/math/3bfbd7bce76c345c2ef3c7f56f861c7c868d535c.svg" alt="z = f(x,\theta)"/> that associates each observation <img class="math" src="../../_images/math/8796c964f035c17f755797d51f050539a5e75915.svg" alt="x_i"/> and values of the  parameters <img class="math" src="../../_images/math/4a214d98ecaa481c3d193c6d03c6d8f62f252017.svg" alt="\theta_i"/> to the parameters of the distribution of the corresponding observation: here <img class="math" src="../../_images/math/934440aac880f667edc2b6918697e56ff4e3d2d3.svg" alt="z=(\mu, \sigma)"/></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fullModelPy</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">Q</span><span class="p">,</span> <span class="n">K_s</span><span class="p">,</span> <span class="n">Z_v</span><span class="p">,</span> <span class="n">Z_m</span> <span class="o">=</span> <span class="n">X</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">X</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sigmaH</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># (m^2) The standard deviation of the observation error.</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">H</span><span class="p">,</span><span class="n">sigmaH</span><span class="p">]</span>

<span class="n">fullModel</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">PythonFunction</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fullModelPy</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">ParametricFunction</span><span class="p">(</span><span class="n">fullModel</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Qobs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">model</span>
</pre></div>
</div>
<p>ParametricEvaluation(class=PythonEvaluation name=OpenTURNSPythonFunction, parameters positions=[0], parameters=[x0 : 2752.94], input positions=[1,2,3])</p>
<br />
<br /><p>Define the value of the reference values of the <img class="math" src="../../_images/math/7e3e48300089e25fc3edb19ddc60fb5e8bbfea3d.svg" alt="\theta"/> parameter. In the bayesian framework, this is called the mean of the <em>prior</em> gaussian distribution. In the data assimilation framework, this is called the <em>background</em>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">KsInitial</span> <span class="o">=</span> <span class="mf">20.</span>
<span class="n">ZvInitial</span> <span class="o">=</span> <span class="mf">49.</span>
<span class="n">ZmInitial</span> <span class="o">=</span> <span class="mf">51.</span>
<span class="n">parameterPriorMean</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Point</span><span class="p">([</span><span class="n">KsInitial</span><span class="p">,</span><span class="n">ZvInitial</span><span class="p">,</span><span class="n">ZmInitial</span><span class="p">])</span>
<span class="n">paramDim</span> <span class="o">=</span> <span class="n">parameterPriorMean</span><span class="o">.</span><span class="n">getDimension</span><span class="p">()</span>
</pre></div>
</div>
<p>Define the covariance matrix of the parameters <img class="math" src="../../_images/math/7e3e48300089e25fc3edb19ddc60fb5e8bbfea3d.svg" alt="\theta"/> to calibrate.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sigmaKs</span> <span class="o">=</span> <span class="mf">5.</span>
<span class="n">sigmaZv</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="n">sigmaZm</span> <span class="o">=</span> <span class="mf">1.</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">parameterPriorCovariance</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">CovarianceMatrix</span><span class="p">(</span><span class="n">paramDim</span><span class="p">)</span>
<span class="n">parameterPriorCovariance</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigmaKs</span><span class="o">**</span><span class="mi">2</span>
<span class="n">parameterPriorCovariance</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigmaZv</span><span class="o">**</span><span class="mi">2</span>
<span class="n">parameterPriorCovariance</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigmaZm</span><span class="o">**</span><span class="mi">2</span>
<span class="n">parameterPriorCovariance</span>
</pre></div>
</div>
<p>[[ 25  0  0 ]<br>
 [  0  1  0 ]<br>
 [  0  0  1 ]]</p>
<br />
<br /><p>Define the the prior distribution <img class="math" src="../../_images/math/80ef82252669162d81d1ee215dbf4f04d7bf236f.svg" alt="\pi(\underline{\theta})"/> of the parameter <img class="math" src="../../_images/math/ee2cb507476c463256f5e73e5a247a5d08ea6b56.svg" alt="\underline{\theta}"/></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">prior</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">parameterPriorMean</span><span class="p">,</span><span class="n">parameterPriorCovariance</span><span class="p">)</span>
<span class="n">prior</span><span class="o">.</span><span class="n">setDescription</span><span class="p">([</span><span class="s1">&#39;Ks&#39;</span><span class="p">,</span> <span class="s1">&#39;Zv&#39;</span><span class="p">,</span> <span class="s1">&#39;Zm&#39;</span><span class="p">])</span>
<span class="n">prior</span>
</pre></div>
</div>
<p>Normal(mu = [20,49,51], sigma = [5,1,1], R = [[ 1 0 0 ]<br>
 [ 0 1 0 ]<br>
 [ 0 0 1 ]])</p>
<br />
<br /><p>Define the distribution of observations <img class="math" src="../../_images/math/52d8461b8dd68dd18807bf0eb02bf081bf21e78d.svg" alt="\underline{y} | \underline{z}"/> conditional on model predictions.</p>
<p>Note that its parameter dimension is the one of <img class="math" src="../../_images/math/88282a59948ee5a9a9ff7692481798150b569f95.svg" alt="\underline{z}"/>, so the model must be adjusted accordingly. In other words, the input argument of the <cite>setParameter</cite> method of the conditional distribution must be equal to the dimension of the output of the <cite>model</cite>. Hence, we do not have to set the actual parameters: only the type of distribution is used.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conditional</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Normal</span><span class="p">()</span>
<span class="n">conditional</span>
</pre></div>
</div>
<p>Normal(mu = 0, sigma = 1)</p>
<br />
<br /><p>Proposal distribution: uniform.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">proposal</span> <span class="o">=</span> <span class="p">[</span><span class="n">ot</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">5.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">),</span><span class="n">ot</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span><span class="n">ot</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)]</span>
<span class="n">proposal</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[class=Uniform name=Uniform dimension=1 a=-5 b=5, class=Uniform name=Uniform dimension=1 a=-1 b=1, class=Uniform name=Uniform dimension=1 a=-1 b=1]
</pre></div>
</div>
</div>
<div class="section" id="test-the-mcmc-sampler">
<h2>Test the MCMC sampler<a class="headerlink" href="#test-the-mcmc-sampler" title="Permalink to this headline">¶</a></h2>
<p>The MCMC sampler essentially computes the log-likelihood of the parameters.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mymcmc</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">MCMC</span><span class="p">(</span><span class="n">prior</span><span class="p">,</span> <span class="n">conditional</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">Qobs</span><span class="p">,</span> <span class="n">Hobs</span><span class="p">,</span> <span class="n">parameterPriorMean</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mymcmc</span><span class="o">.</span><span class="n">computeLogLikelihood</span><span class="p">(</span><span class="n">parameterPriorMean</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>-123.25616677477902
</pre></div>
</div>
</div>
<div class="section" id="test-the-metropolis-hastings-sampler">
<h2>Test the Metropolis-Hastings sampler<a class="headerlink" href="#test-the-metropolis-hastings-sampler" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Creation of the Random Walk Metropolis-Hastings (RWMH) sampler.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">initialState</span> <span class="o">=</span> <span class="n">parameterPriorMean</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RWMHsampler</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">RandomWalkMetropolisHastings</span><span class="p">(</span>
    <span class="n">prior</span><span class="p">,</span> <span class="n">conditional</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">Qobs</span><span class="p">,</span> <span class="n">Hobs</span><span class="p">,</span> <span class="n">initialState</span><span class="p">,</span> <span class="n">proposal</span><span class="p">)</span>
</pre></div>
</div>
<p>Tuning of the RWMH algorithm.</p>
<p>Strategy of calibration for the random walk (trivial example: default).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">strategy</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">CalibrationStrategyCollection</span><span class="p">(</span><span class="n">paramDim</span><span class="p">)</span>
<span class="n">RWMHsampler</span><span class="o">.</span><span class="n">setCalibrationStrategyPerComponent</span><span class="p">(</span><span class="n">strategy</span><span class="p">)</span>
</pre></div>
</div>
<p>Other parameters.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RWMHsampler</span><span class="o">.</span><span class="n">setVerbose</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">RWMHsampler</span><span class="o">.</span><span class="n">setThinning</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">RWMHsampler</span><span class="o">.</span><span class="n">setBurnIn</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
<p>Generate a sample from the posterior distribution of the parameters theta.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sampleSize</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">sample</span> <span class="o">=</span> <span class="n">RWMHsampler</span><span class="o">.</span><span class="n">getSample</span><span class="p">(</span><span class="n">sampleSize</span><span class="p">)</span>
</pre></div>
</div>
<p>Look at the acceptance rate (basic checking of the efficiency of the tuning; value close to 0.2 usually recommended).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RWMHsampler</span><span class="o">.</span><span class="n">getAcceptanceRate</span><span class="p">()</span>
</pre></div>
</div>
<p>[0.546667,0.619167,0.604167]</p>
<br />
<br /><p>Build the distribution of the posterior by kernel smoothing.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kernel</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">KernelSmoothing</span><span class="p">()</span>
<span class="n">posterior</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
</pre></div>
</div>
<p>Display prior vs posterior for each parameter.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">openturns.viewer</span> <span class="kn">import</span> <span class="n">View</span>
<span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">pl</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="k">for</span> <span class="n">parameter_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">paramDim</span><span class="p">):</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">getMarginal</span><span class="p">(</span><span class="n">parameter_index</span><span class="p">)</span><span class="o">.</span><span class="n">drawPDF</span><span class="p">()</span>
    <span class="n">priorGraph</span> <span class="o">=</span> <span class="n">prior</span><span class="o">.</span><span class="n">getMarginal</span><span class="p">(</span><span class="n">parameter_index</span><span class="p">)</span><span class="o">.</span><span class="n">drawPDF</span><span class="p">()</span>
    <span class="n">priorGraph</span><span class="o">.</span><span class="n">setColors</span><span class="p">([</span><span class="s1">&#39;blue&#39;</span><span class="p">])</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">priorGraph</span><span class="p">)</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">setLegends</span><span class="p">([</span><span class="s1">&#39;Posterior&#39;</span><span class="p">,</span> <span class="s1">&#39;Prior&#39;</span><span class="p">])</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">paramDim</span><span class="p">,</span> <span class="n">parameter_index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">View</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="n">ax</span><span class="p">])</span>

<span class="n">_</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Bayesian calibration&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="Bayesian calibration" class="sphx-glr-single-img" src="../../_images/sphx_glr_plot_bayesian_calibration_flooding_001.png" />
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  1.394 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-calibration-bayesian-calibration-plot-bayesian-calibration-flooding-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/e4d2551968c198c67c79607b0f3bcbe8/plot_bayesian_calibration_flooding.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_bayesian_calibration_flooding.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/0fa2e639c50bf6244840c021087984b7/plot_bayesian_calibration_flooding.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_bayesian_calibration_flooding.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../auto_numerical_methods/index.html" title="Numerical methods"
             >next</a> |</li>
        <li class="right" >
          <a href="plot_bayesian_calibration.html" title="Bayesian calibration of a computer code"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">OpenTURNS 1.16dev documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../contents.html" >Contents</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../examples/examples.html" >Examples</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../index.html" >Calibration</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Bayesian calibration of the flooding model</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2005-2018 Airbus-EDF-IMACS-ONERA-Phimeca.
      Last updated on Jan 01, 2018.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.3.0+.
    </div>
  </body>
</html>