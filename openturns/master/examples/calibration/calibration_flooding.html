
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Calibration of the flooding model &#8212; OpenTURNS 1.14dev documentation</title>
    <link rel="stylesheet" href="../../_static/openturns.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Calibration of the Chaboche mecanical model" href="calibration_chaboche.html" />
    <link rel="prev" title="Calibration" href="calibration.html" />
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400,700'
          rel='stylesheet' type='text/css' />
 

  </head><body>
<div class="pageheader">
  <ul>
    <li><a href="http://www.openturns.org/">Home</a></li>
    <li><a href="../../install.html">Get it</a></li>
    <li><a href="../../contents.html">Doc</a></li>
    <li><a href="https://github.com/openturns">Code</a></li>
    <li><a href="https://github.com/openturns/openturns/issues">Bugs</a></li>
  </ul>
  <a href="../../index.html">
    <h1>
      <img src="../../_static/logo-openturns-wo-bg.png" alt="" width=100px height=100px />
      OpenTURNS
    </h1>
    <h2> An Open source initiative for the Treatment of Uncertainties, Risks'N Statistics</h2>
  </a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="calibration_chaboche.html" title="Calibration of the Chaboche mecanical model"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="calibration.html" title="Calibration"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">OpenTURNS 1.14dev documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../contents.html" >Contents</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../examples.html" >Examples</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="calibration.html" accesskey="U">Calibration</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Calibration of the flooding model</a><ul>
<li><a class="reference internal" href="#Model">Model</a></li>
<li><a class="reference internal" href="#Parameters">Parameters</a></li>
<li><a class="reference internal" href="#Outputs">Outputs</a></li>
<li><a class="reference internal" href="#Distribution">Distribution</a></li>
<li><a class="reference internal" href="#Parameters-to-calibrate">Parameters to calibrate</a></li>
<li><a class="reference internal" href="#Observations">Observations</a></li>
<li><a class="reference internal" href="#Analysis">Analysis</a></li>
<li><a class="reference internal" href="#Generate-the-observations">Generate the observations</a></li>
<li><a class="reference internal" href="#A-visualisation-class">A visualisation class</a></li>
<li><a class="reference internal" href="#Setting-the-calibration-parameters">Setting the calibration parameters</a></li>
<li><a class="reference internal" href="#Calibration-with-linear-least-squares">Calibration with linear least squares</a></li>
<li><a class="reference internal" href="#Diagnostic-of-the-identification-issue">Diagnostic of the identification issue</a></li>
<li><a class="reference internal" href="#Conclusion-of-the-linear-least-squares-calibration">Conclusion of the linear least squares calibration</a></li>
<li><a class="reference internal" href="#Calibration-with-non-linear-least-squares">Calibration with non linear least squares</a></li>
<li><a class="reference internal" href="#Analysis-of-the-results">Analysis of the results</a></li>
<li><a class="reference internal" href="#Gaussian-linear-calibration">Gaussian linear calibration</a></li>
<li><a class="reference internal" href="#Analysis-of-the-results">Analysis of the results</a></li>
<li><a class="reference internal" href="#Gaussian-nonlinear-calibration">Gaussian nonlinear calibration</a></li>
<li><a class="reference internal" href="#Analysis-of-the-results">Analysis of the results</a></li>
<li><a class="reference internal" href="#Tuning-the-posterior-distribution-estimation">Tuning the posterior distribution estimation</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="calibration.html"
                        title="previous chapter">Calibration</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="calibration_chaboche.html"
                        title="next chapter">Calibration of the Chaboche mecanical model</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/examples/calibration/calibration_flooding.ipynb"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 7ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<div class="section" id="Calibration-of-the-flooding-model">
<h1>Calibration of the flooding model<a class="headerlink" href="#Calibration-of-the-flooding-model" title="Permalink to this headline">¶</a></h1>
<div class="section" id="Model">
<h2>Model<a class="headerlink" href="#Model" title="Permalink to this headline">¶</a></h2>
<p>The simulator predicts the water height <img class="math" src="../../_images/math/43ab00daa3571041f87a561d387de75cad96009c.svg" alt="H" style="vertical-align: 0px"/> depending on the flowrate <img class="math" src="../../_images/math/2e719bfa618fbb4fc4698366967a264fbba46dd4.svg" alt="Q" style="vertical-align: -3px"/>.</p>
<p>We consider the following four variable:</p>
<ul class="simple">
<li><p><img class="math" src="../../_images/math/2e719bfa618fbb4fc4698366967a264fbba46dd4.svg" alt="Q" style="vertical-align: -3px"/> : the river flowrate (<img class="math" src="../../_images/math/a393fed70c42d3721c10a035e16c64afcf91862d.svg" alt="m^3/s" style="vertical-align: -4px"/>)</p></li>
<li><p><img class="math" src="../../_images/math/1d1c8ac0b765f71b548016e0e9542c9fd230daa1.svg" alt="Ks" style="vertical-align: 0px"/> : the Strickler coefficient (<img class="math" src="../../_images/math/c96cd48af49655c08d64e308df6d6b0b3307a112.svg" alt="m^{1/3}/s" style="vertical-align: -4px"/>)</p></li>
<li><p><img class="math" src="../../_images/math/8c65111b411d8acc67c23f70a96820c191e76c60.svg" alt="Z_v" style="vertical-align: -2px"/> : the downstream riverbed level (m)</p></li>
<li><p><img class="math" src="../../_images/math/297121d3454c7810542417c95f368e09e5bbdd7c.svg" alt="Z_m" style="vertical-align: -2px"/> : the upstream riverbed level (m)</p></li>
</ul>
<p>When the Strickler coefficient increases, the riverbed generates less friction to the water flow.</p>
</div>
<div class="section" id="Parameters">
<h2>Parameters<a class="headerlink" href="#Parameters" title="Permalink to this headline">¶</a></h2>
<p>We consider the following parameters:</p>
<ul class="simple">
<li><p>the length of the river <img class="math" src="../../_images/math/674f685d44e204d0c5abdc6b85851af89ec6deda.svg" alt="L" style="vertical-align: 0px"/> = 5000 (m),</p></li>
<li><p>the width of the river <img class="math" src="../../_images/math/1d71b653f93c4f2b685a484d3080693edd6815ce.svg" alt="B" style="vertical-align: 0px"/> = 300 (m).</p></li>
</ul>
</div>
<div class="section" id="Outputs">
<h2>Outputs<a class="headerlink" href="#Outputs" title="Permalink to this headline">¶</a></h2>
<p>We make the hypothesis that the slope of the river is nonpositive and close to zero, which implies:</p>
<div class="math">
<p><img src="../../_images/math/c15ee300674fbf606cac2a3ada32ad1d07ed5ce3.svg" alt="\alpha = \frac{Z_m - Z_v}{L},"/></p>
</div><p>if <img class="math" src="../../_images/math/e904c8df7c79f25a6339c043fa4376d8aaa94361.svg" alt="Z_m \geq Z_v" style="vertical-align: -2px"/>. The height of the river is:</p>
<div class="math">
<p><img src="../../_images/math/c3534994f7f402b7ec246586b28e11f8bb7da66d.svg" alt="H = \left(\frac{Q}{K_s B \sqrt{\alpha}}\right)^{0.6},"/></p>
</div><p>for any <img class="math" src="../../_images/math/576c0512a2a89645e0a9914bf806339b8da2eaa9.svg" alt="K_s, Q&gt;0" style="vertical-align: -3px"/>.</p>
</div>
<div class="section" id="Distribution">
<h2>Distribution<a class="headerlink" href="#Distribution" title="Permalink to this headline">¶</a></h2>
<p>We assume that the river flowrate has the following truncated Gumbel distribution:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 79%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Variable</p></th>
<th class="head"><p>Distribution</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Q</p></td>
<td><p>Gumbel(scale=558, mode=1013)&gt;0</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="Parameters-to-calibrate">
<h2>Parameters to calibrate<a class="headerlink" href="#Parameters-to-calibrate" title="Permalink to this headline">¶</a></h2>
<p>The vector of parameters to calibrate is:</p>
<div class="math">
<p><img src="../../_images/math/4f50c771bbc0d71095d2ff28da7d58b1f321de96.svg" alt="\theta = (K_s,Z_v,Z_m)."/></p>
</div><p>The variables to calibrate are <img class="math" src="../../_images/math/5455f33bcd018707f895c19d1c6cf12ec363bb15.svg" alt="(K_s,Z_v,Z_m)" style="vertical-align: -4px"/> and are set to the following values:</p>
<div class="math">
<p><img src="../../_images/math/46f627387990a5c60fdc213ddd9e9b5807b6f99c.svg" alt="K_s = 30, \qquad Z_v = 50, \qquad Z_m = 55."/></p>
</div></div>
<div class="section" id="Observations">
<h2>Observations<a class="headerlink" href="#Observations" title="Permalink to this headline">¶</a></h2>
<p>In this section, we describe the statistical model associated with the <img class="math" src="../../_images/math/80b394abd4fb264a3879675f92f191c3e346c3a0.svg" alt="n" style="vertical-align: 0px"/> observations. The errors of the water heights are associated with a gaussian distribution with a zero mean and a standard variation equal to:</p>
<div class="math">
<p><img src="../../_images/math/cc9e07440dff8a3cd441a1ba96af3f321a65f0fd.svg" alt="\sigma=0.1."/></p>
</div><p>Therefore, the observed water heights are:</p>
<div class="math">
<p><img src="../../_images/math/ef52700b2aa7521f3618b931a1fc78f20cbdebee.svg" alt="H_i = G(Q_i,K_s,Z_v,Z_m) + \epsilon_i"/></p>
</div><p>for <img class="math" src="../../_images/math/f547f9b5b4447a6ea60f75e19838225adb8f96e6.svg" alt="i=1,...,n" style="vertical-align: -3px"/> where</p>
<div class="math">
<p><img src="../../_images/math/b1c6973c9d4195a7c89bea351395a4e888af56e3.svg" alt="\epsilon \sim \mathcal{N}(0,\sigma^2)"/></p>
</div><p>and we make the hypothesis that the observation errors are independent. We consider a sample size equal to:</p>
<div class="math">
<p><img src="../../_images/math/55d41c548d379b57ae7ccea260cee47003d87daa.svg" alt="n=100."/></p>
</div><p>The observations are the couples <img class="math" src="../../_images/math/3423cbb5a9a8ebd38fe77deb2b6305937fdc12d2.svg" alt="\{(Q_i,H_i)\}_{i=1,...,n}" style="vertical-align: -5px"/>, i.e. each observation is a couple made of the flowrate and the corresponding river height.</p>
</div>
<div class="section" id="Analysis">
<h2>Analysis<a class="headerlink" href="#Analysis" title="Permalink to this headline">¶</a></h2>
<p>In this model, the variables <img class="math" src="../../_images/math/297121d3454c7810542417c95f368e09e5bbdd7c.svg" alt="Z_m" style="vertical-align: -2px"/> and <img class="math" src="../../_images/math/8c65111b411d8acc67c23f70a96820c191e76c60.svg" alt="Z_v" style="vertical-align: -2px"/> are not identifiables, since only the difference <img class="math" src="../../_images/math/9999c7bca80e36bd32d0ecd9475b8562e3ff7c32.svg" alt="Z_m-Z_v" style="vertical-align: -2px"/> matters. Hence, calibrating this model requires some regularization.</p>
</div>
<div class="section" id="Generate-the-observations">
<h2>Generate the observations<a class="headerlink" href="#Generate-the-observations" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">openturns</span> <span class="kn">as</span> <span class="nn">ot</span>
<span class="n">ot</span><span class="o">.</span><span class="n">ResourceMap</span><span class="o">.</span><span class="n">SetAsUnsignedInteger</span><span class="p">(</span><span class="s1">&#39;Normal-SmallDimension&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We define the model <img class="math" src="../../_images/math/658ae44ee69111e3048325f416f44d6080707928.svg" alt="g" style="vertical-align: -3px"/> which has 4 inputs and one output H.</p>
<p>The nonlinear least squares does not take into account for bounds in the parameters. Therefore, we ensure that the output is computed whatever the inputs. The model fails into two situations:</p>
<ul class="simple">
<li><p>if <img class="math" src="../../_images/math/5368b407d069b73d44d092748eee55867992e987.svg" alt="K_s&lt;0" style="vertical-align: -2px"/>,</p></li>
<li><p>if <img class="math" src="../../_images/math/747754aa15335a1c45edd090361530371d3f0e21.svg" alt="Z_v-Z_m&lt;0" style="vertical-align: -2px"/>.</p></li>
</ul>
<p>In these cases, we return an infinite number, so that the optimization algorithm does not get trapped.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">functionFlooding</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">L</span> <span class="o">=</span> <span class="mf">5.0e3</span>
    <span class="n">B</span> <span class="o">=</span> <span class="mf">300.0</span>
    <span class="n">Q</span><span class="p">,</span> <span class="n">K_s</span><span class="p">,</span> <span class="n">Z_v</span><span class="p">,</span> <span class="n">Z_m</span> <span class="o">=</span> <span class="n">X</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">Z_m</span> <span class="o">-</span> <span class="n">Z_v</span><span class="p">)</span><span class="o">/</span><span class="n">L</span>
    <span class="k">if</span> <span class="n">alpha</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">K_s</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="n">Q</span><span class="o">/</span><span class="p">(</span><span class="n">K_s</span><span class="o">*</span><span class="n">B</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">alpha</span><span class="p">)))</span><span class="o">**</span><span class="p">(</span><span class="mf">3.0</span><span class="o">/</span><span class="mf">5.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">H</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">g</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">PythonFunction</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">functionFlooding</span><span class="p">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">MemoizeFunction</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">setOutputDescription</span><span class="p">([</span><span class="s2">&quot;H (m)&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>Create the input distribution for <img class="math" src="../../_images/math/2e719bfa618fbb4fc4698366967a264fbba46dd4.svg" alt="Q" style="vertical-align: -3px"/>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">Q</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Gumbel</span><span class="p">(</span><span class="mf">558.0</span><span class="p">,</span> <span class="mf">1013.0</span><span class="p">)</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">TruncatedDistribution</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">ot</span><span class="o">.</span><span class="n">TruncatedDistribution</span><span class="o">.</span><span class="n">LOWER</span><span class="p">)</span>
<span class="n">Q</span><span class="o">.</span><span class="n">setDescription</span><span class="p">([</span><span class="s2">&quot;Q (m3/s)&quot;</span><span class="p">])</span>
<span class="n">Q</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<p>TruncatedDistribution(class=ParametrizedDistribution parameters=class=GumbelAB name=Unnamed a=1013 b=558 distribution=class=Gumbel name=Gumbel dimension=1 alpha=0.00179211 beta=1013, bounds = [0, (19000.8) +inf[)</p></div>
</div>
<p>Set the parameters to be calibrated.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">K_s</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Dirac</span><span class="p">(</span><span class="mf">30.0</span><span class="p">)</span>
<span class="n">Z_v</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Dirac</span><span class="p">(</span><span class="mf">50.0</span><span class="p">)</span>
<span class="n">Z_m</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Dirac</span><span class="p">(</span><span class="mf">55.0</span><span class="p">)</span>
<span class="n">K_s</span><span class="o">.</span><span class="n">setDescription</span><span class="p">([</span><span class="s2">&quot;Ks (m^(1/3)/s)&quot;</span><span class="p">])</span>
<span class="n">Z_v</span><span class="o">.</span><span class="n">setDescription</span><span class="p">([</span><span class="s2">&quot;Zv (m)&quot;</span><span class="p">])</span>
<span class="n">Z_m</span><span class="o">.</span><span class="n">setDescription</span><span class="p">([</span><span class="s2">&quot;Zm (m)&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>Create the joint input distribution.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">inputRandomVector</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">ComposedDistribution</span><span class="p">([</span><span class="n">Q</span><span class="p">,</span> <span class="n">K_s</span><span class="p">,</span> <span class="n">Z_v</span><span class="p">,</span> <span class="n">Z_m</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>Create a Monte-Carlo sample of the output H.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">nbobs</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">inputSample</span> <span class="o">=</span> <span class="n">inputRandomVector</span><span class="o">.</span><span class="n">getSample</span><span class="p">(</span><span class="n">nbobs</span><span class="p">)</span>
<span class="n">outputH</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">inputSample</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Observe the distribution of the output H.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ot</span><span class="o">.</span><span class="n">HistogramFactory</span><span class="p">()</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">outputH</span><span class="p">)</span><span class="o">.</span><span class="n">drawPDF</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_calibration_calibration_flooding_15_0.png" src="../../_images/examples_calibration_calibration_flooding_15_0.png" />
</div>
</div>
<p>Generate the observation noise and add it to the output of the model.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">sigmaObservationNoiseH</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1"># (m)</span>
<span class="n">noiseH</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="n">sigmaObservationNoiseH</span><span class="p">)</span>
<span class="n">sampleNoiseH</span> <span class="o">=</span> <span class="n">noiseH</span><span class="o">.</span><span class="n">getSample</span><span class="p">(</span><span class="n">nbobs</span><span class="p">)</span>
<span class="n">Hobs</span> <span class="o">=</span> <span class="n">outputH</span> <span class="o">+</span> <span class="n">sampleNoiseH</span>
</pre></div>
</div>
</div>
<p>Plot the Y observations versus the X observations.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">Qobs</span> <span class="o">=</span> <span class="n">inputSample</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">graph</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="s2">&quot;Observations&quot;</span><span class="p">,</span><span class="s2">&quot;Q (m3/s)&quot;</span><span class="p">,</span><span class="s2">&quot;H (m)&quot;</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
<span class="n">cloud</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Cloud</span><span class="p">(</span><span class="n">Qobs</span><span class="p">,</span><span class="n">Hobs</span><span class="p">)</span>
<span class="n">graph</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cloud</span><span class="p">)</span>
<span class="n">graph</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_calibration_calibration_flooding_20_0.png" src="../../_images/examples_calibration_calibration_flooding_20_0.png" />
</div>
</div>
</div>
<div class="section" id="A-visualisation-class">
<h2>A visualisation class<a class="headerlink" href="#A-visualisation-class" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A graphics class to analyze the results of calibration.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">pylab</span> <span class="kn">as</span> <span class="nn">pl</span>
<span class="kn">import</span> <span class="nn">openturns</span> <span class="kn">as</span> <span class="nn">ot</span>
<span class="kn">import</span> <span class="nn">openturns.viewer</span> <span class="kn">as</span> <span class="nn">otv</span>

<span class="k">class</span> <span class="nc">CalibrationAnalysis</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">calibrationResult</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">inputObservations</span><span class="p">,</span><span class="n">outputObservations</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the prior and posterior distribution of the calibrated parameter theta.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        calibrationResult : :class:`~openturns.calibrationResult`</span>
<span class="sd">            The result of a calibration.</span>

<span class="sd">        model : 2-d sequence of float</span>
<span class="sd">            The function to calibrate.</span>

<span class="sd">        inputObservations : :class:`~openturns.Sample`</span>
<span class="sd">            The sample of input values of the model linked to the observations.</span>

<span class="sd">        outputObservations : 2-d sequence of float</span>
<span class="sd">            The sample of output values of the model linked to the observations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputAtPrior</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputAtPosterior</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibrationResult</span> <span class="o">=</span> <span class="n">calibrationResult</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observationColor</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priorColor</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">posteriorColor</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputObservations</span> <span class="o">=</span> <span class="n">inputObservations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputObservations</span> <span class="o">=</span> <span class="n">outputObservations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unitlength</span> <span class="o">=</span> <span class="mi">6</span> <span class="c1"># inch</span>
        <span class="c1"># Compute yAtPrior</span>
        <span class="n">meanPrior</span> <span class="o">=</span> <span class="n">calibrationResult</span><span class="o">.</span><span class="n">getParameterPrior</span><span class="p">()</span><span class="o">.</span><span class="n">getMean</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">setParameter</span><span class="p">(</span><span class="n">meanPrior</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputAtPrior</span><span class="o">=</span><span class="n">model</span><span class="p">(</span><span class="n">inputObservations</span><span class="p">)</span>
        <span class="c1"># Compute yAtPosterior</span>
        <span class="n">meanPosterior</span> <span class="o">=</span> <span class="n">calibrationResult</span><span class="o">.</span><span class="n">getParameterPosterior</span><span class="p">()</span><span class="o">.</span><span class="n">getMean</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">setParameter</span><span class="p">(</span><span class="n">meanPosterior</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputAtPosterior</span><span class="o">=</span><span class="n">model</span><span class="p">(</span><span class="n">inputObservations</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">drawParameterDistributions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the prior and posterior distribution of the calibrated parameter theta.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">thetaPrior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrationResult</span><span class="o">.</span><span class="n">getParameterPrior</span><span class="p">()</span>
        <span class="n">thetaDescription</span> <span class="o">=</span> <span class="n">thetaPrior</span><span class="o">.</span><span class="n">getDescription</span><span class="p">()</span>
        <span class="n">thetaPosterior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrationResult</span><span class="o">.</span><span class="n">getParameterPosterior</span><span class="p">()</span>
        <span class="n">thetaDim</span> <span class="o">=</span> <span class="n">thetaPosterior</span><span class="o">.</span><span class="n">getDimension</span><span class="p">()</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">thetaDim</span><span class="p">):</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">thetaDescription</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s2">&quot;PDF&quot;</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="s2">&quot;topright&quot;</span><span class="p">)</span>
            <span class="c1"># Prior distribution</span>
            <span class="n">thetaPrior_i</span> <span class="o">=</span> <span class="n">thetaPrior</span><span class="o">.</span><span class="n">getMarginal</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">priorPDF</span> <span class="o">=</span> <span class="n">thetaPrior_i</span><span class="o">.</span><span class="n">drawPDF</span><span class="p">()</span>
            <span class="n">priorPDF</span><span class="o">.</span><span class="n">setColors</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">priorColor</span><span class="p">])</span>
            <span class="n">priorPDF</span><span class="o">.</span><span class="n">setLegends</span><span class="p">([</span><span class="s2">&quot;Prior&quot;</span><span class="p">])</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">priorPDF</span><span class="p">)</span>
            <span class="c1"># Posterior distribution</span>
            <span class="n">thetaPosterior_i</span> <span class="o">=</span> <span class="n">thetaPosterior</span><span class="o">.</span><span class="n">getMarginal</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">postPDF</span> <span class="o">=</span> <span class="n">thetaPosterior_i</span><span class="o">.</span><span class="n">drawPDF</span><span class="p">()</span>
            <span class="n">postPDF</span><span class="o">.</span><span class="n">setColors</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">posteriorColor</span><span class="p">])</span>
            <span class="n">postPDF</span><span class="o">.</span><span class="n">setLegends</span><span class="p">([</span><span class="s2">&quot;Posterior&quot;</span><span class="p">])</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">postPDF</span><span class="p">)</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            If the prior is a Dirac, set the vertical axis bounds to the posterior.</span>
<span class="sd">            Otherwise, the Dirac set to [0,1], where the 1 can be much larger</span>
<span class="sd">            than the maximum PDF of the posterior.</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">thetaPrior_i</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span><span class="o">==</span><span class="s2">&quot;Dirac&quot;</span><span class="p">):</span>
                <span class="c1"># The vertical (PDF) bounds of the posterior</span>
                <span class="n">postbb</span> <span class="o">=</span> <span class="n">postPDF</span><span class="o">.</span><span class="n">getBoundingBox</span><span class="p">()</span>
                <span class="n">pdf_upper</span> <span class="o">=</span> <span class="n">postbb</span><span class="o">.</span><span class="n">getUpperBound</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">pdf_lower</span> <span class="o">=</span> <span class="n">postbb</span><span class="o">.</span><span class="n">getLowerBound</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># Set these bounds to the graph</span>
                <span class="n">bb</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">getBoundingBox</span><span class="p">()</span>
                <span class="n">graph_upper</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getUpperBound</span><span class="p">()</span>
                <span class="n">graph_upper</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdf_upper</span>
                <span class="n">bb</span><span class="o">.</span><span class="n">setUpperBound</span><span class="p">(</span><span class="n">graph_upper</span><span class="p">)</span>
                <span class="n">graph_lower</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getLowerBound</span><span class="p">()</span>
                <span class="n">graph_lower</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdf_lower</span>
                <span class="n">bb</span><span class="o">.</span><span class="n">setLowerBound</span><span class="p">(</span><span class="n">graph_lower</span><span class="p">)</span>
                <span class="n">graph</span><span class="o">.</span><span class="n">setBoundingBox</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
            <span class="c1"># Add it to the graphics</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">thetaDim</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">otv</span><span class="o">.</span><span class="n">View</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="n">ax</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">drawObservationsVsPredictions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the output of the model depending</span>
<span class="sd">        on the output observations before and after calibration.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ySize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputObservations</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>
        <span class="n">yDim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputObservations</span><span class="o">.</span><span class="n">getDimension</span><span class="p">()</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;Observations&quot;</span><span class="p">,</span><span class="s2">&quot;Predictions&quot;</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="s2">&quot;topleft&quot;</span><span class="p">)</span>
        <span class="c1"># Plot the diagonal</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">yDim</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drawObservationsVsPredictions1Dimension</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputObservations</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">outputAtPrior</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">outputAtPosterior</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">ySize</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">outputObservations</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputObservations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">outputAtPrior</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputAtPrior</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">outputAtPosterior</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputAtPosterior</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drawObservationsVsPredictions1Dimension</span><span class="p">(</span><span class="n">outputObservations</span><span class="p">,</span><span class="n">outputAtPrior</span><span class="p">,</span><span class="n">outputAtPosterior</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unitlength</span><span class="o">*</span><span class="n">yDim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unitlength</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">yDim</span><span class="p">):</span>
                <span class="n">outputObservations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputObservations</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
                <span class="n">outputAtPrior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputAtPrior</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
                <span class="n">outputAtPosterior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputAtPosterior</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
                <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drawObservationsVsPredictions1Dimension</span><span class="p">(</span><span class="n">outputObservations</span><span class="p">,</span><span class="n">outputAtPrior</span><span class="p">,</span><span class="n">outputAtPosterior</span><span class="p">)</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">yDim</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">otv</span><span class="o">.</span><span class="n">View</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="n">ax</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">graph</span>

    <span class="k">def</span> <span class="nf">_drawObservationsVsPredictions1Dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outputObservations</span><span class="p">,</span><span class="n">outputAtPrior</span><span class="p">,</span><span class="n">outputAtPosterior</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the output of the model depending</span>
<span class="sd">        on the output observations before and after calibration.</span>
<span class="sd">        Can manage only 1D samples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">yDim</span> <span class="o">=</span> <span class="n">outputObservations</span><span class="o">.</span><span class="n">getDimension</span><span class="p">()</span>
        <span class="n">ydescription</span> <span class="o">=</span> <span class="n">outputObservations</span><span class="o">.</span><span class="n">getDescription</span><span class="p">()</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Observations&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ydescription</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Predictions&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ydescription</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">xlabel</span><span class="p">,</span><span class="n">ylabel</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="s2">&quot;topleft&quot;</span><span class="p">)</span>
        <span class="c1"># Plot the diagonal</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">yDim</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">curve</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Curve</span><span class="p">(</span><span class="n">outputObservations</span><span class="p">,</span> <span class="n">outputObservations</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">setColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observationColor</span><span class="p">)</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">curve</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Output observations are not 1D.&#39;</span><span class="p">)</span>
        <span class="c1"># Plot the predictions before</span>
        <span class="n">yPriorDim</span> <span class="o">=</span> <span class="n">outputAtPrior</span><span class="o">.</span><span class="n">getDimension</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">yPriorDim</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">cloud</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Cloud</span><span class="p">(</span><span class="n">outputObservations</span><span class="p">,</span> <span class="n">outputAtPrior</span><span class="p">)</span>
            <span class="n">cloud</span><span class="o">.</span><span class="n">setColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priorColor</span><span class="p">)</span>
            <span class="n">cloud</span><span class="o">.</span><span class="n">setLegend</span><span class="p">(</span><span class="s2">&quot;Prior&quot;</span><span class="p">)</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cloud</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Output prior predictions are not 1D.&#39;</span><span class="p">)</span>
        <span class="c1"># Plot the predictions after</span>
        <span class="n">yPosteriorDim</span> <span class="o">=</span> <span class="n">outputAtPosterior</span><span class="o">.</span><span class="n">getDimension</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">yPosteriorDim</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">cloud</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Cloud</span><span class="p">(</span><span class="n">outputObservations</span><span class="p">,</span> <span class="n">outputAtPosterior</span><span class="p">)</span>
            <span class="n">cloud</span><span class="o">.</span><span class="n">setColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">posteriorColor</span><span class="p">)</span>
            <span class="n">cloud</span><span class="o">.</span><span class="n">setLegend</span><span class="p">(</span><span class="s2">&quot;Posterior&quot;</span><span class="p">)</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cloud</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Output posterior predictions are not 1D.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">graph</span>

    <span class="k">def</span> <span class="nf">drawResiduals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the distribution of the residuals and</span>
<span class="sd">        the distribution of the observation errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ySize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputObservations</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>
        <span class="n">yDim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputObservations</span><span class="o">.</span><span class="n">getDimension</span><span class="p">()</span>
        <span class="n">yPriorSize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputAtPrior</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>
        <span class="n">yPriorDim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputAtPrior</span><span class="o">.</span><span class="n">getDimension</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">yDim</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">observationsError</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrationResult</span><span class="o">.</span><span class="n">getObservationsError</span><span class="p">()</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drawResiduals1Dimension</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputObservations</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">outputAtPrior</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">outputAtPosterior</span><span class="p">,</span><span class="n">observationsError</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">ySize</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">outputObservations</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputObservations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">outputAtPrior</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputAtPrior</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">outputAtPosterior</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputAtPosterior</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">observationsError</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrationResult</span><span class="o">.</span><span class="n">getObservationsError</span><span class="p">()</span>
            <span class="c1"># In this case, we cannot draw observationsError ; just</span>
            <span class="c1"># pass the required input argument, but it is not actually used.</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drawResiduals1Dimension</span><span class="p">(</span><span class="n">outputObservations</span><span class="p">,</span><span class="n">outputAtPrior</span><span class="p">,</span><span class="n">outputAtPosterior</span><span class="p">,</span><span class="n">observationsError</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">observationsError</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrationResult</span><span class="o">.</span><span class="n">getObservationsError</span><span class="p">()</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unitlength</span><span class="o">*</span><span class="n">yDim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unitlength</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">yDim</span><span class="p">):</span>
                <span class="n">outputObservations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputObservations</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
                <span class="n">outputAtPrior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputAtPrior</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
                <span class="n">outputAtPosterior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputAtPosterior</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
                <span class="n">observationsErrorYi</span> <span class="o">=</span> <span class="n">observationsError</span><span class="o">.</span><span class="n">getMarginal</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drawResiduals1Dimension</span><span class="p">(</span><span class="n">outputObservations</span><span class="p">,</span><span class="n">outputAtPrior</span><span class="p">,</span><span class="n">outputAtPosterior</span><span class="p">,</span><span class="n">observationsErrorYi</span><span class="p">)</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">yDim</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">otv</span><span class="o">.</span><span class="n">View</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="n">ax</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">graph</span>

    <span class="k">def</span> <span class="nf">_drawResiduals1Dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outputObservations</span><span class="p">,</span><span class="n">outputAtPrior</span><span class="p">,</span><span class="n">outputAtPosterior</span><span class="p">,</span><span class="n">observationsError</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the distribution of the residuals and</span>
<span class="sd">        the distribution of the observation errors.</span>
<span class="sd">        Can manage only 1D samples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ydescription</span> <span class="o">=</span> <span class="n">outputObservations</span><span class="o">.</span><span class="n">getDescription</span><span class="p">()</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Residuals&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ydescription</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="s2">&quot;Residuals analysis&quot;</span><span class="p">,</span><span class="n">xlabel</span><span class="p">,</span><span class="s2">&quot;Probability distribution function&quot;</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="s2">&quot;topright&quot;</span><span class="p">)</span>
        <span class="n">yDim</span> <span class="o">=</span> <span class="n">outputObservations</span><span class="o">.</span><span class="n">getDimension</span><span class="p">()</span>
        <span class="n">yPriorDim</span> <span class="o">=</span> <span class="n">outputAtPrior</span><span class="o">.</span><span class="n">getDimension</span><span class="p">()</span>
        <span class="n">yPosteriorDim</span> <span class="o">=</span> <span class="n">outputAtPrior</span><span class="o">.</span><span class="n">getDimension</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">yDim</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">yPriorDim</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">posteriorResiduals</span> <span class="o">=</span> <span class="n">outputObservations</span> <span class="o">-</span> <span class="n">outputAtPrior</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">KernelSmoothing</span><span class="p">()</span>
            <span class="n">fittedDist</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">posteriorResiduals</span><span class="p">)</span>
            <span class="n">residualPDF</span> <span class="o">=</span> <span class="n">fittedDist</span><span class="o">.</span><span class="n">drawPDF</span><span class="p">()</span>
            <span class="n">residualPDF</span><span class="o">.</span><span class="n">setColors</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">priorColor</span><span class="p">])</span>
            <span class="n">residualPDF</span><span class="o">.</span><span class="n">setLegends</span><span class="p">([</span><span class="s2">&quot;Prior&quot;</span><span class="p">])</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">residualPDF</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Output prior observations are not 1D.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">yDim</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">yPosteriorDim</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">posteriorResiduals</span> <span class="o">=</span> <span class="n">outputObservations</span> <span class="o">-</span> <span class="n">outputAtPosterior</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">KernelSmoothing</span><span class="p">()</span>
            <span class="n">fittedDist</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">posteriorResiduals</span><span class="p">)</span>
            <span class="n">residualPDF</span> <span class="o">=</span> <span class="n">fittedDist</span><span class="o">.</span><span class="n">drawPDF</span><span class="p">()</span>
            <span class="n">residualPDF</span><span class="o">.</span><span class="n">setColors</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">posteriorColor</span><span class="p">])</span>
            <span class="n">residualPDF</span><span class="o">.</span><span class="n">setLegends</span><span class="p">([</span><span class="s2">&quot;Posterior&quot;</span><span class="p">])</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">residualPDF</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Output posterior observations are not 1D.&#39;</span><span class="p">)</span>
        <span class="c1"># Plot the distribution of the observation errors</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">observationsError</span><span class="o">.</span><span class="n">getDimension</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># In the other case, we just do not plot</span>
            <span class="n">obserrgraph</span> <span class="o">=</span> <span class="n">observationsError</span><span class="o">.</span><span class="n">drawPDF</span><span class="p">()</span>
            <span class="n">obserrgraph</span><span class="o">.</span><span class="n">setColors</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">observationColor</span><span class="p">])</span>
            <span class="n">obserrgraph</span><span class="o">.</span><span class="n">setLegends</span><span class="p">([</span><span class="s2">&quot;Observation errors&quot;</span><span class="p">])</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obserrgraph</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">graph</span>

    <span class="k">def</span> <span class="nf">drawObservationsVsInputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the observed output of the model depending</span>
<span class="sd">        on the observed input before and after calibration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xSize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputObservations</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>
        <span class="n">ySize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputObservations</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>
        <span class="n">xDim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputObservations</span><span class="o">.</span><span class="n">getDimension</span><span class="p">()</span>
        <span class="n">yDim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputObservations</span><span class="o">.</span><span class="n">getDimension</span><span class="p">()</span>
        <span class="n">xdescription</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputObservations</span><span class="o">.</span><span class="n">getDescription</span><span class="p">()</span>
        <span class="n">ydescription</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputObservations</span><span class="o">.</span><span class="n">getDescription</span><span class="p">()</span>
        <span class="c1"># Observations</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">xDim</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">yDim</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drawObservationsVsInputs1Dimension</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputObservations</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">outputObservations</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">outputAtPrior</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">outputAtPosterior</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">xSize</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ySize</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">inputObservations</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputObservations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">outputObservations</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputObservations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">outputAtPrior</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputAtPrior</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">outputAtPosterior</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputAtPosterior</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drawObservationsVsInputs1Dimension</span><span class="p">(</span><span class="n">inputObservations</span><span class="p">,</span><span class="n">outputObservations</span><span class="p">,</span><span class="n">outputAtPrior</span><span class="p">,</span><span class="n">outputAtPosterior</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">xDim</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">unitlength</span><span class="p">,</span> <span class="n">yDim</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">unitlength</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xDim</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">yDim</span><span class="p">):</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">xDim</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="n">i</span>
                    <span class="n">inputObservations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputObservations</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">outputObservations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputObservations</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">outputAtPrior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputAtPrior</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">outputAtPosterior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputAtPosterior</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drawObservationsVsInputs1Dimension</span><span class="p">(</span><span class="n">inputObservations</span><span class="p">,</span><span class="n">outputObservations</span><span class="p">,</span><span class="n">outputAtPrior</span><span class="p">,</span><span class="n">outputAtPosterior</span><span class="p">)</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">yDim</span><span class="p">,</span> <span class="n">xDim</span><span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">_</span> <span class="o">=</span> <span class="n">otv</span><span class="o">.</span><span class="n">View</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="n">ax</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">graph</span>

    <span class="k">def</span> <span class="nf">_drawObservationsVsInputs1Dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inputObservations</span><span class="p">,</span><span class="n">outputObservations</span><span class="p">,</span><span class="n">outputAtPrior</span><span class="p">,</span><span class="n">outputAtPosterior</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the observed output of the model depending</span>
<span class="sd">        on the observed input before and after calibration.</span>
<span class="sd">        Can manage only 1D samples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xDim</span> <span class="o">=</span> <span class="n">inputObservations</span><span class="o">.</span><span class="n">getDimension</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">xDim</span><span class="o">!=</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Input observations are not 1D.&#39;</span><span class="p">)</span>
        <span class="n">yDim</span> <span class="o">=</span> <span class="n">outputObservations</span><span class="o">.</span><span class="n">getDimension</span><span class="p">()</span>
        <span class="n">xdescription</span> <span class="o">=</span> <span class="n">inputObservations</span><span class="o">.</span><span class="n">getDescription</span><span class="p">()</span>
        <span class="n">ydescription</span> <span class="o">=</span> <span class="n">outputObservations</span><span class="o">.</span><span class="n">getDescription</span><span class="p">()</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">xdescription</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ydescription</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">True</span><span class="p">,</span><span class="s2">&quot;topright&quot;</span><span class="p">)</span>
        <span class="c1"># Observations</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">yDim</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">cloud</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Cloud</span><span class="p">(</span><span class="n">inputObservations</span><span class="p">,</span><span class="n">outputObservations</span><span class="p">)</span>
            <span class="n">cloud</span><span class="o">.</span><span class="n">setColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observationColor</span><span class="p">)</span>
            <span class="n">cloud</span><span class="o">.</span><span class="n">setLegend</span><span class="p">(</span><span class="s2">&quot;Observations&quot;</span><span class="p">)</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cloud</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Output observations are not 1D.&#39;</span><span class="p">)</span>
        <span class="c1"># Model outputs before calibration</span>
        <span class="n">yPriorDim</span> <span class="o">=</span> <span class="n">outputAtPrior</span><span class="o">.</span><span class="n">getDimension</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">yPriorDim</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">cloud</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Cloud</span><span class="p">(</span><span class="n">inputObservations</span><span class="p">,</span><span class="n">outputAtPrior</span><span class="p">)</span>
            <span class="n">cloud</span><span class="o">.</span><span class="n">setColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priorColor</span><span class="p">)</span>
            <span class="n">cloud</span><span class="o">.</span><span class="n">setLegend</span><span class="p">(</span><span class="s2">&quot;Prior&quot;</span><span class="p">)</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cloud</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Output prior predictions are not 1D.&#39;</span><span class="p">)</span>
        <span class="c1"># Model outputs after calibration</span>
        <span class="n">yPosteriorDim</span> <span class="o">=</span> <span class="n">outputAtPosterior</span><span class="o">.</span><span class="n">getDimension</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">yPosteriorDim</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">cloud</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Cloud</span><span class="p">(</span><span class="n">inputObservations</span><span class="p">,</span><span class="n">outputAtPosterior</span><span class="p">)</span>
            <span class="n">cloud</span><span class="o">.</span><span class="n">setColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">posteriorColor</span><span class="p">)</span>
            <span class="n">cloud</span><span class="o">.</span><span class="n">setLegend</span><span class="p">(</span><span class="s2">&quot;Posterior&quot;</span><span class="p">)</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cloud</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Output posterior predictions are not 1D.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">graph</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Setting-the-calibration-parameters">
<h2>Setting the calibration parameters<a class="headerlink" href="#Setting-the-calibration-parameters" title="Permalink to this headline">¶</a></h2>
<p>Define the value of the reference values of the <img class="math" src="../../_images/math/7e3e48300089e25fc3edb19ddc60fb5e8bbfea3d.svg" alt="\theta" style="vertical-align: 0px"/> parameter. In the bayesian framework, this is called the mean of the <em>prior</em> gaussian distribution. In the data assimilation framework, this is called the <em>background</em>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">KsInitial</span> <span class="o">=</span> <span class="mf">20.</span>
<span class="n">ZvInitial</span> <span class="o">=</span> <span class="mf">49.</span>
<span class="n">ZmInitial</span> <span class="o">=</span> <span class="mf">51.</span>
<span class="n">thetaPrior</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Point</span><span class="p">([</span><span class="n">KsInitial</span><span class="p">,</span><span class="n">ZvInitial</span><span class="p">,</span><span class="n">ZmInitial</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>The following statement create the calibrated function from the model. The calibrated parameters Ks, Zv, Zm are at indices 1, 2, 3 in the inputs arguments of the model.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">calibratedIndices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="n">mycf</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">ParametricFunction</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">calibratedIndices</span><span class="p">,</span> <span class="n">thetaPrior</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Calibration-with-linear-least-squares">
<h2>Calibration with linear least squares<a class="headerlink" href="#Calibration-with-linear-least-squares" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">LinearLeastSquaresCalibration</span></code> class performs the linear least squares calibration by linearizing the model in the neighbourhood of the reference point.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">algo</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">LinearLeastSquaresCalibration</span><span class="p">(</span><span class="n">mycf</span><span class="p">,</span> <span class="n">Qobs</span><span class="p">,</span> <span class="n">Hobs</span><span class="p">,</span> <span class="n">thetaPrior</span><span class="p">,</span> <span class="s2">&quot;SVD&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">run</span></code> method computes the solution of the problem.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">calibrationResult</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">getResult</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">getParameterMAP</span></code> method returns the maximum of the posterior distribution of <img class="math" src="../../_images/math/7e3e48300089e25fc3edb19ddc60fb5e8bbfea3d.svg" alt="\theta" style="vertical-align: 0px"/>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">thetaStar</span> <span class="o">=</span> <span class="n">calibrationResult</span><span class="o">.</span><span class="n">getParameterMAP</span><span class="p">()</span>
<span class="n">thetaStar</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<p>[-1.01509e+08,-1.11013e+24,-1.11013e+24]</p></div>
</div>
<p>In this case, we see that there seems to be a great distance from the reference value of <img class="math" src="../../_images/math/7e3e48300089e25fc3edb19ddc60fb5e8bbfea3d.svg" alt="\theta" style="vertical-align: 0px"/> to the optimum: the values seem too large in magnitude. The value of the optimum <img class="math" src="../../_images/math/e44d8c9524edab58aff01eacfa07ca07dac18df2.svg" alt="K_s" style="vertical-align: -2px"/> is nonpositive. In fact, there is an identification problem because the Jacobian matrix is rank-degenerate.</p>
</div>
<div class="section" id="Diagnostic-of-the-identification-issue">
<h2>Diagnostic of the identification issue<a class="headerlink" href="#Diagnostic-of-the-identification-issue" title="Permalink to this headline">¶</a></h2>
<p>In this section, we show how to diagnose the identification problem.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">getParameterPosterior</span></code> method returns the posterior gaussian distribution of <img class="math" src="../../_images/math/7e3e48300089e25fc3edb19ddc60fb5e8bbfea3d.svg" alt="\theta" style="vertical-align: 0px"/>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">distributionPosterior</span> <span class="o">=</span> <span class="n">calibrationResult</span><span class="o">.</span><span class="n">getParameterPosterior</span><span class="p">()</span>
<span class="n">distributionPosterior</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<p>Normal(mu = [-1.01509e+08,-1.11013e+24,-1.11013e+24], sigma = [6.62225e+27,5.20609e+33,5.20609e+33], R = [[  1            1.40425e-26 -1.40425e-26 ]<br>
 [  1.40425e-26  1            1           ]<br>
 [ -1.40425e-26  1            1           ]])</p></div>
</div>
<p>We see that there is a large covariance matrix diagonal.</p>
<p>Let us compute a 95% confidence interval for the solution <img class="math" src="../../_images/math/b57c014f32c1e20b3d05757fc29e0d77fec3cb67.svg" alt="\theta^\star" style="vertical-align: 0px"/>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">distributionPosterior</span><span class="o">.</span><span class="n">computeBilateralConfidenceIntervalWithMarginalProbability</span><span class="p">(</span><span class="mf">0.95</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<p>[-2.24441e+26, 2.24441e+26]<br>
[-1.76444e+32, 1.76444e+32]<br>
[-1.76444e+32, 1.76444e+32]</p></div>
</div>
<p>The confidence interval is <em>very</em> large.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">mycf</span><span class="o">.</span><span class="n">setParameter</span><span class="p">(</span><span class="n">thetaPrior</span><span class="p">)</span>
<span class="n">thetaDim</span> <span class="o">=</span> <span class="n">thetaPrior</span><span class="o">.</span><span class="n">getDimension</span><span class="p">()</span>
<span class="n">jacobianMatrix</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="n">nbobs</span><span class="p">,</span><span class="n">thetaDim</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbobs</span><span class="p">):</span>
    <span class="n">jacobianMatrix</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">mycf</span><span class="o">.</span><span class="n">parameterGradient</span><span class="p">(</span><span class="n">Qobs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="n">jacobianMatrix</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">,:]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<p>5x3<br>
[[ -0.133438   0.667192  -0.667192  ]<br>
 [ -0.170638   0.853188  -0.853188  ]<br>
 [ -0.0808351  0.404175  -0.404175  ]<br>
 [ -0.0546252  0.273126  -0.273126  ]<br>
 [ -0.105857   0.529285  -0.529285  ]]</p></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">jacobianMatrix</span><span class="o">.</span><span class="n">computeSingularValues</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<p>[9.72877,1.6948e-10,5.11532e-26]</p></div>
</div>
<p>We can see that there are two singular values which are relatively close to zero.</p>
<p>This explains why the Jacobian matrix is close to being rank-degenerate.</p>
</div>
<div class="section" id="Conclusion-of-the-linear-least-squares-calibration">
<h2>Conclusion of the linear least squares calibration<a class="headerlink" href="#Conclusion-of-the-linear-least-squares-calibration" title="Permalink to this headline">¶</a></h2>
<p>There are several methods to solve the problem.</p>
<ul class="simple">
<li><p>Given that the problem is not identifiable, we can use some regularization method. Two methods are provided in the library: the gaussian linear least squares <code class="docutils literal notranslate"><span class="pre">GaussianLinearCalibration</span></code> and the gaussian non linear least squares <code class="docutils literal notranslate"><span class="pre">GaussianNonlinearCalibration</span></code>.</p></li>
<li><p>We can change the problem, replacing it with a problem which is identifiable. In the flooding model, replacing <img class="math" src="../../_images/math/d7c4fb1beb3f35e0bff85a40d7565241e0b439a1.svg" alt="Z_v-Z_m" style="vertical-align: -2px"/> with <img class="math" src="../../_images/math/1ab7dbcff841bbdc3c8316d4a2aa6b0c0161e91d.svg" alt="\Delta Z" style="vertical-align: 0px"/> allows to solve the issue.</p></li>
</ul>
</div>
<div class="section" id="Calibration-with-non-linear-least-squares">
<h2>Calibration with non linear least squares<a class="headerlink" href="#Calibration-with-non-linear-least-squares" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">NonLinearLeastSquaresCalibration</span></code> class performs the non linear least squares calibration by minimizing the squared euclidian norm between the predictions and the observations.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">algo</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">NonLinearLeastSquaresCalibration</span><span class="p">(</span><span class="n">mycf</span><span class="p">,</span> <span class="n">Qobs</span><span class="p">,</span> <span class="n">Hobs</span><span class="p">,</span> <span class="n">thetaPrior</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">run</span></code> method computes the solution of the problem.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">calibrationResult</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">getResult</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Analysis-of-the-results">
<h2>Analysis of the results<a class="headerlink" href="#Analysis-of-the-results" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">getParameterMAP</span></code> method returns the maximum of the posterior distribution of <img class="math" src="../../_images/math/7e3e48300089e25fc3edb19ddc60fb5e8bbfea3d.svg" alt="\theta" style="vertical-align: 0px"/>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">thetaMAP</span> <span class="o">=</span> <span class="n">calibrationResult</span><span class="o">.</span><span class="n">getParameterMAP</span><span class="p">()</span>
<span class="n">thetaMAP</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<p>[33.5324,47.9616,52.0384]</p></div>
</div>
<p>We can compute a 95% confidence interval of the parameter <img class="math" src="../../_images/math/b57c014f32c1e20b3d05757fc29e0d77fec3cb67.svg" alt="\theta^\star" style="vertical-align: 0px"/>.</p>
<p>This confidence interval is based on bootstrap, based on a sample size equal to 100 (as long as the value of the <code class="docutils literal notranslate"><span class="pre">ResourceMap</span></code> key “NonLinearLeastSquaresCalibration-BootstrapSize” is unchanged). This confidence interval reflects the sensitivity of the optimum to the variability in the observations.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">thetaPosterior</span> <span class="o">=</span> <span class="n">calibrationResult</span><span class="o">.</span><span class="n">getParameterPosterior</span><span class="p">()</span>
<span class="n">thetaPosterior</span><span class="o">.</span><span class="n">computeBilateralConfidenceIntervalWithMarginalProbability</span><span class="p">(</span><span class="mf">0.95</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<p>[29.0757, 37.6979]<br>
[47.2008, 48.3945]<br>
[51.6055, 52.7992]</p></div>
</div>
<p>In this case, the value of the parameter <img class="math" src="../../_images/math/e44d8c9524edab58aff01eacfa07ca07dac18df2.svg" alt="K_s" style="vertical-align: -2px"/> is quite accurately computed, but there is a relatively large uncertainty on the values of <img class="math" src="../../_images/math/8c65111b411d8acc67c23f70a96820c191e76c60.svg" alt="Z_v" style="vertical-align: -2px"/> and <img class="math" src="../../_images/math/297121d3454c7810542417c95f368e09e5bbdd7c.svg" alt="Z_m" style="vertical-align: -2px"/>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">mypcr</span> <span class="o">=</span> <span class="n">CalibrationAnalysis</span><span class="p">(</span><span class="n">calibrationResult</span><span class="p">,</span><span class="n">mycf</span><span class="p">,</span> <span class="n">Qobs</span><span class="p">,</span><span class="n">Hobs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">graph</span> <span class="o">=</span> <span class="n">mypcr</span><span class="o">.</span><span class="n">drawObservationsVsInputs</span><span class="p">()</span>
<span class="n">graph</span><span class="o">.</span><span class="n">setLegendPosition</span><span class="p">(</span><span class="s2">&quot;topleft&quot;</span><span class="p">)</span>
<span class="n">graph</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_calibration_calibration_flooding_61_0.png" src="../../_images/examples_calibration_calibration_flooding_61_0.png" />
</div>
</div>
<p>We see that there is a good fit after calibration, since the predictions after calibration (i.e. the green crosses) are close to the observations (i.e. the blue crosses).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">mypcr</span><span class="o">.</span><span class="n">drawObservationsVsPredictions</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_calibration_calibration_flooding_63_0.png" src="../../_images/examples_calibration_calibration_flooding_63_0.png" />
</div>
</div>
<p>We see that there is a much better fit after calibration, since the predictions are close to the diagonal of the graphics.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">observationError</span> <span class="o">=</span> <span class="n">calibrationResult</span><span class="o">.</span><span class="n">getObservationsError</span><span class="p">()</span>
<span class="n">observationError</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<p>Normal(mu = -0.00982084, sigma = 0.107725)</p></div>
</div>
<p>We can see that the observation error is close to have a zero mean and a standard deviation equal to 0.1.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">graph</span> <span class="o">=</span> <span class="n">mypcr</span><span class="o">.</span><span class="n">drawResiduals</span><span class="p">()</span>
<span class="n">graph</span><span class="o">.</span><span class="n">setLegendPosition</span><span class="p">(</span><span class="s2">&quot;topleft&quot;</span><span class="p">)</span>
<span class="n">graph</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_calibration_calibration_flooding_67_0.png" src="../../_images/examples_calibration_calibration_flooding_67_0.png" />
</div>
</div>
<p>The analysis of the residuals shows that the distribution is centered on zero and symmetric. This indicates that the calibration performed well.</p>
<p>Moreover, the distribution of the residuals is close to being gaussian.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">_</span> <span class="o">=</span> <span class="n">mypcr</span><span class="o">.</span><span class="n">drawParameterDistributions</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_calibration_calibration_flooding_69_0.png" src="../../_images/examples_calibration_calibration_flooding_69_0.png" />
</div>
</div>
</div>
<div class="section" id="Gaussian-linear-calibration">
<h2>Gaussian linear calibration<a class="headerlink" href="#Gaussian-linear-calibration" title="Permalink to this headline">¶</a></h2>
<p>The standard deviation of the observations.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">sigmaH</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># (m^2)</span>
</pre></div>
</div>
</div>
<p>Define the covariance matrix of the output Y of the model.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">errorCovariance</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">CovarianceMatrix</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">errorCovariance</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigmaH</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
</div>
<p>Define the covariance matrix of the parameters <img class="math" src="../../_images/math/7e3e48300089e25fc3edb19ddc60fb5e8bbfea3d.svg" alt="\theta" style="vertical-align: 0px"/> to calibrate.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">sigmaKs</span> <span class="o">=</span> <span class="mf">5.</span>
<span class="n">sigmaZv</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="n">sigmaZm</span> <span class="o">=</span> <span class="mf">1.</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">sigma</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">CovarianceMatrix</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigmaKs</span><span class="o">**</span><span class="mi">2</span>
<span class="n">sigma</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigmaZv</span><span class="o">**</span><span class="mi">2</span>
<span class="n">sigma</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigmaZm</span><span class="o">**</span><span class="mi">2</span>
<span class="n">sigma</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<p>[[ 25  0  0 ]<br>
 [  0  1  0 ]<br>
 [  0  0  1 ]]</p></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">GaussianLinearCalibration</span></code> class performs the gaussian linear calibration by linearizing the model in the neighbourhood of the prior.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">algo</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">GaussianLinearCalibration</span><span class="p">(</span><span class="n">mycf</span><span class="p">,</span> <span class="n">Qobs</span><span class="p">,</span> <span class="n">Hobs</span><span class="p">,</span> <span class="n">thetaPrior</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">errorCovariance</span><span class="p">,</span><span class="s2">&quot;SVD&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">run</span></code> method computes the solution of the problem.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">calibrationResult</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">getResult</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Analysis-of-the-results">
<h2>Analysis of the results<a class="headerlink" href="#Analysis-of-the-results" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">getParameterMAP</span></code> method returns the maximum of the posterior distribution of <img class="math" src="../../_images/math/7e3e48300089e25fc3edb19ddc60fb5e8bbfea3d.svg" alt="\theta" style="vertical-align: 0px"/>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">thetaStar</span> <span class="o">=</span> <span class="n">calibrationResult</span><span class="o">.</span><span class="n">getParameterMAP</span><span class="p">()</span>
<span class="n">thetaStar</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<p>[24.5218,48.0956,51.9044]</p></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">mypcr</span> <span class="o">=</span> <span class="n">CalibrationAnalysis</span><span class="p">(</span><span class="n">calibrationResult</span><span class="p">,</span><span class="n">mycf</span><span class="p">,</span> <span class="n">Qobs</span><span class="p">,</span><span class="n">Hobs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">graph</span> <span class="o">=</span> <span class="n">mypcr</span><span class="o">.</span><span class="n">drawObservationsVsInputs</span><span class="p">()</span>
<span class="n">graph</span><span class="o">.</span><span class="n">setLegendPosition</span><span class="p">(</span><span class="s2">&quot;topleft&quot;</span><span class="p">)</span>
<span class="n">graph</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_calibration_calibration_flooding_87_0.png" src="../../_images/examples_calibration_calibration_flooding_87_0.png" />
</div>
</div>
<p>We see that the output of the model after calibration is closer to the observations. However, there is still a distance from the outputs of the model to the observations. This indicates that the calibration cannot be performed with this method.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">mypcr</span><span class="o">.</span><span class="n">drawObservationsVsPredictions</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_calibration_calibration_flooding_89_0.png" src="../../_images/examples_calibration_calibration_flooding_89_0.png" />
</div>
</div>
<p>In this case, the fit is better after calibration, but not perfect. Indeed, the cloud of points after calibration is not centered on the diagonal.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">graph</span> <span class="o">=</span> <span class="n">mypcr</span><span class="o">.</span><span class="n">drawResiduals</span><span class="p">()</span>
<span class="n">graph</span><span class="o">.</span><span class="n">setLegendPosition</span><span class="p">(</span><span class="s2">&quot;topleft&quot;</span><span class="p">)</span>
<span class="n">graph</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_calibration_calibration_flooding_91_0.png" src="../../_images/examples_calibration_calibration_flooding_91_0.png" />
</div>
</div>
<p>We see that the distribution of the residual is not centered on zero: the mean residual is approximately -0.5, which implies that the predictions are, on average, smaller than the observations. This is a proof that the calibration cannot be performed with this method in this particular case.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">getParameterPosterior</span></code> method returns the posterior gaussian distribution of <img class="math" src="../../_images/math/7e3e48300089e25fc3edb19ddc60fb5e8bbfea3d.svg" alt="\theta" style="vertical-align: 0px"/>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">distributionPosterior</span> <span class="o">=</span> <span class="n">calibrationResult</span><span class="o">.</span><span class="n">getParameterPosterior</span><span class="p">()</span>
<span class="n">distributionPosterior</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<p>Normal(mu = [24.5218,48.0956,51.9044], sigma = [4.08431,0.816862,0.816862], R = [[  1         0.498657 -0.498657 ]<br>
 [  0.498657  1         0.498657 ]<br>
 [ -0.498657  0.498657  1        ]])</p></div>
</div>
<p>We can compute a 95% confidence interval of the parameter <img class="math" src="../../_images/math/b57c014f32c1e20b3d05757fc29e0d77fec3cb67.svg" alt="\theta^\star" style="vertical-align: 0px"/>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">distributionPosterior</span><span class="o">.</span><span class="n">computeBilateralConfidenceIntervalWithMarginalProbability</span><span class="p">(</span><span class="mf">0.95</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<p>[14.9481, 34.0954]<br>
[46.1809, 50.0104]<br>
[49.9896, 53.8191]</p></div>
</div>
<p>We see that there is a large uncertainty on the value of the parameter <img class="math" src="../../_images/math/e44d8c9524edab58aff01eacfa07ca07dac18df2.svg" alt="K_s" style="vertical-align: -2px"/> which can be as small as 14 and as large as 34.</p>
<p>We can compare the prior and posterior distributions of the marginals of <img class="math" src="../../_images/math/7e3e48300089e25fc3edb19ddc60fb5e8bbfea3d.svg" alt="\theta" style="vertical-align: 0px"/>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">_</span> <span class="o">=</span> <span class="n">mypcr</span><span class="o">.</span><span class="n">drawParameterDistributions</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_calibration_calibration_flooding_99_0.png" src="../../_images/examples_calibration_calibration_flooding_99_0.png" />
</div>
</div>
<p>The two distributions are different, which shows that the calibration is sensible to the observations (if the observations were not sensible, the two distributions were superimposed). Moreover, the two distributions are quite close, which implies that the prior distribution has played a roled in the calibration (otherwise the two distributions would be completely different, indicating that only the observations were taken into account).</p>
</div>
<div class="section" id="Gaussian-nonlinear-calibration">
<h2>Gaussian nonlinear calibration<a class="headerlink" href="#Gaussian-nonlinear-calibration" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">GaussianNonLinearCalibration</span></code> class performs the gaussian nonlinear calibration.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">algo</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">GaussianNonLinearCalibration</span><span class="p">(</span><span class="n">mycf</span><span class="p">,</span> <span class="n">Qobs</span><span class="p">,</span> <span class="n">Hobs</span><span class="p">,</span> <span class="n">thetaPrior</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">errorCovariance</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">run</span></code> method computes the solution of the problem.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">calibrationResult</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">getResult</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Analysis-of-the-results">
<h2>Analysis of the results<a class="headerlink" href="#Analysis-of-the-results" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">getParameterMAP</span></code> method returns the maximum of the posterior distribution of <img class="math" src="../../_images/math/7e3e48300089e25fc3edb19ddc60fb5e8bbfea3d.svg" alt="\theta" style="vertical-align: 0px"/>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">thetaStar</span> <span class="o">=</span> <span class="n">calibrationResult</span><span class="o">.</span><span class="n">getParameterMAP</span><span class="p">()</span>
<span class="n">thetaStar</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<p>[30.6807,47.6248,52.3752]</p></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">mypcr</span> <span class="o">=</span> <span class="n">CalibrationAnalysis</span><span class="p">(</span><span class="n">calibrationResult</span><span class="p">,</span><span class="n">mycf</span><span class="p">,</span> <span class="n">Qobs</span><span class="p">,</span><span class="n">Hobs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">graph</span> <span class="o">=</span> <span class="n">mypcr</span><span class="o">.</span><span class="n">drawObservationsVsInputs</span><span class="p">()</span>
<span class="n">graph</span><span class="o">.</span><span class="n">setLegendPosition</span><span class="p">(</span><span class="s2">&quot;topleft&quot;</span><span class="p">)</span>
<span class="n">graph</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_calibration_calibration_flooding_111_0.png" src="../../_images/examples_calibration_calibration_flooding_111_0.png" />
</div>
</div>
<p>We see that the output of the model after calibration is in the middle of the observations: the calibration seems correct.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">mypcr</span><span class="o">.</span><span class="n">drawObservationsVsPredictions</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_calibration_calibration_flooding_113_0.png" src="../../_images/examples_calibration_calibration_flooding_113_0.png" />
</div>
</div>
<p>The fit is excellent after calibration. Indeed, the cloud of points after calibration is on the diagonal.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">mypcr</span><span class="o">.</span><span class="n">drawResiduals</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_calibration_calibration_flooding_115_0.png" src="../../_images/examples_calibration_calibration_flooding_115_0.png" />
</div>
</div>
<p>We see that the histogram of the residual is centered on zero. This is a proof that the calibration did perform correctly.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">getParameterPosterior</span></code> method returns the posterior gaussian distribution of <img class="math" src="../../_images/math/7e3e48300089e25fc3edb19ddc60fb5e8bbfea3d.svg" alt="\theta" style="vertical-align: 0px"/>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">distributionPosterior</span> <span class="o">=</span> <span class="n">calibrationResult</span><span class="o">.</span><span class="n">getParameterPosterior</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>We can compute a 95% confidence interval of the parameter <img class="math" src="../../_images/math/b57c014f32c1e20b3d05757fc29e0d77fec3cb67.svg" alt="\theta^\star" style="vertical-align: 0px"/>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">distributionPosterior</span><span class="o">.</span><span class="n">computeBilateralConfidenceIntervalWithMarginalProbability</span><span class="p">(</span><span class="mf">0.95</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<p>[30.6113, 31.1594]<br>
[47.5635, 47.6337]<br>
[52.3663, 52.4365]</p></div>
</div>
<p>We see that there is a small uncertainty on the value of all parameters.</p>
<p>We can compare the prior and posterior distributions of the marginals of <img class="math" src="../../_images/math/7e3e48300089e25fc3edb19ddc60fb5e8bbfea3d.svg" alt="\theta" style="vertical-align: 0px"/>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">_</span> <span class="o">=</span> <span class="n">mypcr</span><span class="o">.</span><span class="n">drawParameterDistributions</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_calibration_calibration_flooding_123_0.png" src="../../_images/examples_calibration_calibration_flooding_123_0.png" />
</div>
</div>
<p>The two distributions are very different, with a spiky posterior distribution. This shows that the calibration is very sensible to the observations.</p>
</div>
<div class="section" id="Tuning-the-posterior-distribution-estimation">
<h2>Tuning the posterior distribution estimation<a class="headerlink" href="#Tuning-the-posterior-distribution-estimation" title="Permalink to this headline">¶</a></h2>
<p>The “GaussianNonLinearCalibration-BootstrapSize” key controls the posterior distribution estimation.</p>
<ul class="simple">
<li><p>If “GaussianNonLinearCalibration-BootstrapSize” &gt; 0 (by default it is equal to 100), then a bootstrap resample algorithm is used to see the dispersion of the MAP estimator. This allows to see the variability of the estimator with respect to the finite observation sample.</p></li>
<li><p>If “GaussianNonLinearCalibration-BootstrapSize” is zero, then the gaussian linear calibration estimator is used (i.e. the <code class="docutils literal notranslate"><span class="pre">GaussianLinearCalibration</span></code> class) at the optimum. This is called the Laplace approximation.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ot</span><span class="o">.</span><span class="n">ResourceMap_SetAsUnsignedInteger</span><span class="p">(</span><span class="s2">&quot;GaussianNonLinearCalibration-BootstrapSize&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[62]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">calibrationResult</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">getResult</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[63]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">_</span> <span class="o">=</span> <span class="n">mypcr</span><span class="o">.</span><span class="n">drawParameterDistributions</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_calibration_calibration_flooding_129_0.png" src="../../_images/examples_calibration_calibration_flooding_129_0.png" />
</div>
</div>
<p>As we can see, this does not change much the posterior distribution, which remains spiky.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="calibration_chaboche.html" title="Calibration of the Chaboche mecanical model"
             >next</a> |</li>
        <li class="right" >
          <a href="calibration.html" title="Calibration"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">OpenTURNS 1.14dev documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../contents.html" >Contents</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../examples.html" >Examples</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="calibration.html" >Calibration</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2005-2018 Airbus-EDF-IMACS-ONERA-Phimeca.
      Last updated on Jan 01, 2018.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.0.0+/075aa332b.
    </div>
  </body>
</html>