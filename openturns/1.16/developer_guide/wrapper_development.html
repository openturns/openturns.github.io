
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wrapper development &#8212; OpenTURNS 1.16rc1 documentation</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/openturns.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/gallery-dataframe.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/js/mysearchtools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Git workflow" href="git_workflow.html" />
    <link rel="prev" title="Module development" href="module_development.html" />
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400,700'
          rel='stylesheet' type='text/css' />
 

  </head><body>
<div class="pageheader">
  <ul>
    <li><a href="http://www.openturns.org/">Home</a></li>
    <li><a href="../install.html">Get it</a></li>
    <li><a href="../contents.html">Doc</a></li>
    <li><a href="https://openturns.discourse.group/">Forum</a></li>
    <li><a href="https://gitter.im/openturns/community">Chat</a></li>
    <li><a href="https://github.com/openturns">Code</a></li>
    <li><a href="https://github.com/openturns/openturns/issues">Bugs</a></li>
  </ul>
  <a href="../index.html">
    <h1>
      <img src="../_static/logo-openturns-wo-bg.png" alt="" width=100px height=100px />
      OpenTURNS
    </h1>
    <h2> An Open source initiative for the Treatment of Uncertainties, Risks'N Statistics</h2>
  </a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="git_workflow.html" title="Git workflow"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="module_development.html" title="Module development"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">OpenTURNS 1.16rc1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../contents.html" >Contents</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="developer_guide.html" accesskey="U">Contribute</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Wrapper development</a></li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Wrapper development</a><ul>
<li><a class="reference internal" href="#pure-python-wrappers">Pure python wrappers</a><ul>
<li><a class="reference internal" href="#pythonfunction">PythonFunction</a></li>
<li><a class="reference internal" href="#external-code-coupling-tools">External code coupling tools</a><ul>
<li><a class="reference internal" href="#simple-example">Simple example</a></li>
<li><a class="reference internal" href="#more-examples">More examples</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#performance-considerations">Performance considerations</a><ul>
<li><a class="reference internal" href="#symbolic-formula">Symbolic formula</a><ul>
<li><a class="reference internal" href="#benchmark-sources">Benchmark sources</a></li>
<li><a class="reference internal" href="#benchmark-results">Benchmark results</a></li>
<li><a class="reference internal" href="#conclusion">Conclusion</a></li>
</ul>
</li>
<li><a class="reference internal" href="#external-process">External process</a><ul>
<li><a class="reference internal" href="#normal-program">Normal program</a></li>
<li><a class="reference internal" href="#tiny-program">Tiny program</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="module_development.html"
                        title="previous chapter">Module development</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="git_workflow.html"
                        title="next chapter">Git workflow</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/developer_guide/wrapper_development.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="wrapper-development">
<h1>Wrapper development<a class="headerlink" href="#wrapper-development" title="Permalink to this headline">¶</a></h1>
<div class="section" id="pure-python-wrappers">
<h2>Pure python wrappers<a class="headerlink" href="#pure-python-wrappers" title="Permalink to this headline">¶</a></h2>
<p>Python wrappers aim to be an easy way for wrapping external code. The
external code can be a mathematical formula or a coupling
involving several computational codes dedicated to the resolution of a
very complex physical problem.</p>
<p>Python wrappers are not the best solution if your external code last
less than a microseconds and if you need to resolve billions of points.
In that case, for better performance, consider using a compiled wrapper.
In any other cases, a Python wrapper is the recommended choice.</p>
<div class="section" id="pythonfunction">
<h3>PythonFunction<a class="headerlink" href="#pythonfunction" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../user_manual/_generated/openturns.PythonFunction.html#openturns.PythonFunction" title="openturns.PythonFunction"><code class="xref py py-class docutils literal notranslate"><span class="pre">PythonFunction</span></code></a> is a <a class="reference internal" href="../user_manual/_generated/openturns.Function.html#openturns.Function" title="openturns.Function"><code class="xref py py-class docutils literal notranslate"><span class="pre">Function</span></code></a> which
execution is done in a Python context.</p>
<p>Here is an example of how to use it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">openturns</span> <span class="k">as</span> <span class="nn">ot</span>

<span class="k">def</span> <span class="nf">compute_point</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">E</span><span class="p">,</span> <span class="n">F</span> <span class="o">=</span> <span class="n">X</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">E</span> <span class="o">*</span> <span class="n">F</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">Y</span><span class="p">]</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">PythonFunction</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">compute_point</span><span class="p">)</span>
<span class="n">out_sample</span> <span class="o">=</span> <span class="n">model</span><span class="p">([[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">]])</span>
<span class="n">model</span><span class="o">.</span><span class="n">gradient</span><span class="p">([</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">])</span>
</pre></div>
</div>
<p>Some explanations of the code :</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">compute_point</span></code> function constructs the out point from the in
point. The in and out array size must correspond to the sizes set in
the PythonFunction constructor. In this example, X will be an array
of size 2 and Y must be an array of size 1. The output point can be a
Python list, an  Point or a Numpy array.</p></li>
</ul>
<p>The evaluation can be done on several points to benefit from vectorization.
It receives an input sample and must return an output sample. Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">openturns</span> <span class="k">as</span> <span class="nn">ot</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">exec_sample</span><span class="p">(</span><span class="n">Xs</span><span class="p">):</span>
    <span class="c1"># speedup using numpy</span>
    <span class="n">XsT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Xs</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">XsT</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">XsT</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">PythonFunction</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">func_sample</span><span class="o">=</span><span class="n">exec_sample</span><span class="p">)</span>
</pre></div>
</div>
<p>The output sample can be a Sample, a Python list of list or a
Numpy array of array. This argument is optional. If <code class="docutils literal notranslate"><span class="pre">func_sample</span></code> is
not provided and must compute a sample, the <code class="docutils literal notranslate"><span class="pre">func</span></code> function is
called several time: once for each point of the sample. On contrary, if
only <code class="docutils literal notranslate"><span class="pre">func_sample</span></code> is given and a point must be computed, the point
is inserted in a sample of size 1, and extracted from the result sample.</p>
<p>The PythonFunction is quite simple to use. When used with
coupling_tools module, it can wrap external program easily too.</p>
</div>
<div class="section" id="external-code-coupling-tools">
<h3>External code coupling tools<a class="headerlink" href="#external-code-coupling-tools" title="Permalink to this headline">¶</a></h3>
<div class="section" id="simple-example">
<h4>Simple example<a class="headerlink" href="#simple-example" title="Permalink to this headline">¶</a></h4>
<p>Here is a simple example of wrapper where compute is made in an external
program with the help of openturns.coupling_tools module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">openturns</span> <span class="k">as</span> <span class="nn">ot</span>
<span class="kn">import</span> <span class="nn">openturns.coupling_tools</span> <span class="k">as</span> <span class="nn">ct</span>

<span class="n">external_program</span> <span class="o">=</span> <span class="s1">&#39;python external_program.py&#39;</span>

<span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="c1"># create input file</span>
    <span class="n">in_file</span> <span class="o">=</span> <span class="s1">&#39;input.py&#39;</span>
    <span class="n">ct</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;input_template.py&#39;</span><span class="p">,</span> <span class="n">in_file</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;@E&#39;</span><span class="p">,</span> <span class="s1">&#39;@F&#39;</span><span class="p">],</span> <span class="n">X</span><span class="p">)</span>

    <span class="c1"># compute</span>
    <span class="n">ct</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">external_program</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">in_file</span><span class="p">)</span>

    <span class="c1"># parse output file</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output.py&#39;</span><span class="p">,</span> <span class="n">tokens</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Z=&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">Y</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">PythonFunction</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">exec</span><span class="p">)</span>
<span class="n">out_sample</span> <span class="o">=</span> <span class="n">model</span><span class="p">([[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">]])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">out_sample</span><span class="p">)</span>
</pre></div>
</div>
<p>Some explanations of the code :</p>
<ul class="simple">
<li><p><a class="reference internal" href="../user_manual/_generated/openturns.coupling_tools.replace.html#openturns.coupling_tools.replace" title="openturns.coupling_tools.replace"><code class="xref py py-meth docutils literal notranslate"><span class="pre">replace()</span></code></a> replace <code class="docutils literal notranslate"><span class="pre">&#64;E</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;F</span></code> occurence found
in <code class="docutils literal notranslate"><span class="pre">input_template.py</span></code> file and write the result to <code class="docutils literal notranslate"><span class="pre">infile</span></code>
file. <code class="docutils literal notranslate"><span class="pre">X[0]</span></code> value will replace <code class="docutils literal notranslate"><span class="pre">'&#64;E'</span></code> token and <code class="docutils literal notranslate"><span class="pre">X[1]</span></code> will
replace <code class="docutils literal notranslate"><span class="pre">'&#64;F'</span></code> token.</p></li>
<li><p>The external program is launched with <a class="reference internal" href="../user_manual/_generated/openturns.coupling_tools.execute.html#openturns.coupling_tools.execute" title="openturns.coupling_tools.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">execute()</span></code></a>.
The input filename is passed by parameters to the program.</p></li>
<li><p><a class="reference internal" href="../user_manual/_generated/openturns.coupling_tools.get.html#openturns.coupling_tools.get" title="openturns.coupling_tools.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get()</span></code></a> get the value following <code class="docutils literal notranslate"><span class="pre">'Z='</span></code> token in
<code class="docutils literal notranslate"><span class="pre">output.py</span></code> file.</p></li>
</ul>
<p>Template file example <code class="docutils literal notranslate"><span class="pre">input_template.py</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">E</span><span class="o">=</span><span class="nd">@E</span>
<span class="n">F</span><span class="o">=</span><span class="nd">@F</span>
</pre></div>
</div>
<p>External program example <code class="docutils literal notranslate"><span class="pre">external_program.py</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># get input</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">inFile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">exec</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">inFile</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">inFile</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">))</span>

<span class="c1"># compute</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">F</span> <span class="o">*</span> <span class="n">E</span>

<span class="c1"># write output</span>
<span class="n">h</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;output.py&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
<span class="n">h</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Z=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">Z</span><span class="p">))</span>
<span class="n">h</span><span class="o">.</span><span class="n">close</span>
</pre></div>
</div>
<p>Output file example <code class="docutils literal notranslate"><span class="pre">output.py</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span><span class="o">=</span><span class="mf">42.0</span>
</pre></div>
</div>
</div>
<div class="section" id="more-examples">
<h4>More examples<a class="headerlink" href="#more-examples" title="Permalink to this headline">¶</a></h4>
<p>The replace <a class="reference internal" href="../user_manual/_generated/openturns.coupling_tools.replace.html#openturns.coupling_tools.replace" title="openturns.coupling_tools.replace"><code class="xref py py-meth docutils literal notranslate"><span class="pre">replace()</span></code></a> function
can edit file in place. It can format values in anyway. Actually, values
can be of type “string”, if not, they are converted using str() Python
function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">replace</span><span class="p">(</span><span class="n">outfile</span><span class="o">=</span><span class="s1">&#39;input_template.py&#39;</span><span class="p">,</span> <span class="n">infile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="n">tokens</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;@E&#39;</span><span class="p">,</span> <span class="s1">&#39;@F&#39;</span><span class="p">],</span> <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="mf">5.2569</span><span class="p">,</span> <span class="s1">&#39;toto&#39;</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">replace</span><span class="p">(</span><span class="n">outfile</span><span class="o">=</span><span class="s1">&#39;input_template.py&#39;</span><span class="p">,</span> <span class="n">infile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="n">tokens</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;@E&#39;</span><span class="p">,</span> <span class="s1">&#39;@F&#39;</span><span class="p">],</span> <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="mf">5.2569</span><span class="p">,</span> <span class="s1">&#39;toto&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>The input_template.py file will then be modify like this :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">E</span><span class="o">=</span><span class="mf">5.25</span>
<span class="n">F</span><span class="o">=</span><span class="n">toto</span>
</pre></div>
</div>
<p>Be careful with overlapping tokens:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># if input_template.py = &#39;E=@E EE=@EE&#39;)</span>
<span class="n">replace</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="s2">&quot;input_template.py&quot;</span><span class="p">,</span>
<span class="n">outfile</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
<span class="n">tokens</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;@E&quot;</span><span class="p">,</span> <span class="s2">&quot;@EE&quot;</span><span class="p">],</span>
<span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="c1"># =&gt; raise exception!! -&gt; @EE token not found!</span>
<span class="c1"># (this is due to the first pass with token &quot;@E&quot; that modify</span>
<span class="c1"># &quot;input_template.py&quot; like this : &#39;E=1 EE=1E&#39;)</span>
</pre></div>
</div>
<p>Solution to overlapping tokens: put longest tokens first:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># template.in = &#39;E=@E EE=@EE&#39;)</span>
<span class="n">replace</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="s2">&quot;template.in&quot;</span><span class="p">,</span>
<span class="n">outfile</span><span class="o">=</span><span class="s2">&quot;prgm_data.in&quot;</span><span class="p">,</span>
<span class="n">tokens</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;@EE&quot;</span><span class="p">,</span> <span class="s2">&quot;@E&quot;</span><span class="p">],</span>
<span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="c1"># =&gt; prgm_data.in = &#39;E=1 EE=2&#39;)</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="../user_manual/_generated/openturns.coupling_tools.execute.html#openturns.coupling_tools.execute" title="openturns.coupling_tools.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">execute()</span></code></a> function
can launch an external code.</p>
<p>The <a class="reference internal" href="../user_manual/_generated/openturns.coupling_tools.get_value.html#openturns.coupling_tools.get_value" title="openturns.coupling_tools.get_value"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_value()</span></code></a> function
can deal with several type of output file.</p>
<ul>
<li><p>content of the results.out file used for the following examples</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span>  <span class="mi">2</span>  <span class="mi">3</span>  <span class="mi">04</span>  <span class="mi">5</span>  <span class="mi">6</span>
<span class="mi">7</span>  <span class="mi">8</span>  <span class="mi">9</span>  <span class="mi">10</span>
<span class="mi">11</span> <span class="mi">12</span> <span class="mi">13</span> <span class="mi">14</span>

<span class="nd">@Y1</span><span class="o">=</span> <span class="mf">11.11</span><span class="n">celcius</span>
<span class="nd">@Y2</span><span class="o">=</span> <span class="o">-</span><span class="mf">0.89</span>
<span class="nd">@Y1</span><span class="o">=</span> <span class="mf">22.22</span>
<span class="nd">@Y1</span><span class="o">=</span> <span class="mf">33.33</span>

<span class="n">line1</span><span class="p">:</span> <span class="mi">100</span> <span class="mi">101</span> <span class="mi">102</span>
<span class="n">line2</span><span class="p">:</span> <span class="mi">200</span> <span class="mi">201</span> <span class="mi">202</span>
<span class="n">line3</span><span class="p">:</span> <span class="mi">300</span> <span class="mi">301</span> <span class="mi">302</span>
</pre></div>
</div>
</li>
<li><p>search token, the value right after the token is returned:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Y</span> <span class="o">=</span> <span class="n">get_value</span><span class="p">(</span><span class="s1">&#39;results.out&#39;</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="s1">&#39;@Y1=&#39;</span><span class="p">)</span> <span class="c1"># 11.11</span>
</pre></div>
</div>
</li>
<li><p>skip lines and columns (useful for array search):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">get_value</span><span class="p">(</span><span class="s1">&#39;results.out&#39;</span><span class="p">,</span> <span class="n">skip_line</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skip_col</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># 9</span>
</pre></div>
</div>
</li>
<li><p>skip lines and columns backward (be careful: if there is an empty
line at the end of the file, it is taken into account. i.e. this
last empty line will be reached using skip_line=-1):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">get_value</span><span class="p">(</span><span class="s1">&#39;results.out&#39;</span><span class="p">,</span> <span class="n">skip_line</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">skip_col</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># 201</span>
</pre></div>
</div>
</li>
<li><p>search the 3rd appearance of the token:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">get_value</span><span class="p">(</span><span class="s1">&#39;results.out&#39;</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="s1">&#39;@Y1=&#39;</span><span class="p">,</span> <span class="n">skip_token</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># 33.33</span>
</pre></div>
</div>
</li>
<li><p>search the 2nd appearance of the token from the end of the file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">get_value</span><span class="p">(</span><span class="s1">&#39;results.out&#39;</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="s1">&#39;@Y1=&#39;</span><span class="p">,</span> <span class="n">skip_token</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># 22.22</span>
</pre></div>
</div>
</li>
<li><p>search a token and then skip lines and columns from this token:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">get_value</span><span class="p">(</span><span class="s1">&#39;results.out&#39;</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="s1">&#39;@Y1=&#39;</span><span class="p">,</span> <span class="n">skip_line</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">skip_col</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># 101</span>
</pre></div>
</div>
</li>
<li><p>search the 2nd token and then skip lines and columns from this
token:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">get_value</span><span class="p">(</span><span class="s1">&#39;results.out&#39;</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="s1">&#39;@Y1=&#39;</span><span class="p">,</span> <span class="n">skip_token</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skip_line</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">skip_col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 300</span>
</pre></div>
</div>
</li>
</ul>
<p>The <a class="reference internal" href="../user_manual/_generated/openturns.coupling_tools.get.html#openturns.coupling_tools.get" title="openturns.coupling_tools.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get()</span></code></a> function
works actually the same way the get_value function do,
but on several parameters:</p>
<p>The <a class="reference internal" href="../user_manual/_generated/openturns.coupling_tools.get_regex.html#openturns.coupling_tools.get_regex" title="openturns.coupling_tools.get_regex"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_regex()</span></code></a> function
parses output files. It is provided for backward compatibility:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Y</span> <span class="o">=</span> <span class="n">get_regex</span><span class="p">(</span><span class="s1">&#39;results.out&#39;</span><span class="p">,</span> <span class="n">patterns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;@Y2=(\R)&#39;</span><span class="p">])</span> <span class="c1"># -0.89</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="performance-considerations">
<h2>Performance considerations<a class="headerlink" href="#performance-considerations" title="Permalink to this headline">¶</a></h2>
<p>Two differents cases can be encounter when wrapping code: the wrapping
code is a mathematical formula or it is an external code (an external process).</p>
<div class="section" id="symbolic-formula">
<h3>Symbolic formula<a class="headerlink" href="#symbolic-formula" title="Permalink to this headline">¶</a></h3>
<p>A benchmark involving the differents wrapping methods available from
has been done using a dummy symbolic formula.</p>
<div class="section" id="benchmark-sources">
<h4>Benchmark sources<a class="headerlink" href="#benchmark-sources" title="Permalink to this headline">¶</a></h4>
<p>Optimizations of any parts of this benchmark are welcome.</p>
<ul>
<li><p>Benchmark of PythonFunction using _exec function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">big_sample</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">getSample</span><span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">openturns</span> <span class="k">as</span> <span class="nn">ot</span>

<span class="k">def</span> <span class="nf">_exec</span><span class="p">(</span> <span class="n">X</span> <span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">PythonFunction</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">_exec</span><span class="p">)</span>
    <span class="c1"># start timer</span>
    <span class="n">out_sample</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span> <span class="n">big_sample</span> <span class="p">)</span>
    <span class="c1"># stop timer</span>
</pre></div>
</div>
</li>
<li><p>Benchmark of PythonFunction using _exec_sample function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_exec_sample</span><span class="p">(</span> <span class="n">Xs</span> <span class="p">):</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="n">XsT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Xs</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">xT</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xT</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">PythonFunction</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">func_sample</span><span class="o">=</span><span class="n">_exec_sample</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Benchmark of symbolic (muParser) function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">SymbolicFunction</span><span class="p">([</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;x1&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;cos((x0+1)^2) - sin(x1)&#39;</span><span class="p">])</span>
</pre></div>
</div>
</li>
</ul>
<p>The benchmark is done on a bi XEON E5520 (Nehalem 16*2.27GHz, HT
activated) with 12Go RAM.</p>
</div>
<div class="section" id="benchmark-results">
<h4>Benchmark results<a class="headerlink" href="#benchmark-results" title="Permalink to this headline">¶</a></h4>
<p>The sample containing 1 million of points is allocated in 0.282s.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 43%" />
<col style="width: 12%" />
<col style="width: 45%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>wrapper type</p></td>
<td><p>time</p></td>
<td><p>comparison with fastest wrapper</p></td>
</tr>
<tr class="row-even"><td><p>PythonFunction _exec</p></td>
<td><p>7.1s</p></td>
<td><p>x157</p></td>
</tr>
<tr class="row-odd"><td><p>PythonFunction _exec_sample</p></td>
<td><p>1.3s</p></td>
<td><p>x30</p></td>
</tr>
<tr class="row-even"><td><p>Symbolic (muParser)</p></td>
<td><p>0.43s</p></td>
<td><p>x10</p></td>
</tr>
</tbody>
</table>
<p>The previous results are linear to the size of the sample.</p>
<ul>
<li><p>muParser is the 2nd fastest (10 times slower than the first).</p>
<p>The muParser library used is not multithreaded. Embedding a
parallel version of muParser could give better results.</p>
</li>
<li><p>Using an optimized _exec_sample python function through numpy gives
better results (6x faster) than a simple _exec python function, but
it is still much slower than the compiled library (30 times slower).</p>
<p>Note that neither Python nor NumPy are multithreaded.</p>
</li>
</ul>
</div>
<div class="section" id="conclusion">
<h4>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h4>
<p>PythonFunction is the easiest and more adaptable wrapper but it’s the
slowest too. So, if you need to compute samples containing less than a
million of points, PythonFunction is the good choice as the speed
difference between wrappers will not be noticeable: every wrappers will
compute the sample in less than a second. Otherwise choose muParser.</p>
</div>
</div>
<div class="section" id="external-process">
<h3>External process<a class="headerlink" href="#external-process" title="Permalink to this headline">¶</a></h3>
<div class="section" id="normal-program">
<h4>Normal program<a class="headerlink" href="#normal-program" title="Permalink to this headline">¶</a></h4>
<p>For usual program (compute time of 1s and above), inner wrapper
complexity/overhead are not an issue cause the external program compute
time will be the main part of the whole compute time. Sample can be
computed faster by launching this external program in parallel.</p>
<ul class="simple">
<li><p>PythonFunction can not launch the _exec function in parallel.</p></li>
<li><p>the DistributedPythonFunction from otdistfunc module can launch
external program on each core of the local Machine or on each core of
several remote machine.</p></li>
</ul>
<p>The DistributedPythonFunction is the best choice as it combine the ease
of use of Python with the ability to deploy compute on a cluster of
computers.</p>
</div>
<div class="section" id="tiny-program">
<h4>Tiny program<a class="headerlink" href="#tiny-program" title="Permalink to this headline">¶</a></h4>
<p>If the external process compute time is really fast (&lt; 0.1s),  wrapper
point’s launch time (overhead) becomes important.</p>
<p>If performance are an issue, one should first consider that the external
process is perhaps fast because it does something simple: can it be
easily reimplemented in Python? If the code is not too complex, execute
Python code inside a PythonFunction is usually much faster than the time
to start the external process ( 1000x). Here is a naive example of
external process (scilab) vs PythonFunction.</p>
<ul>
<li><p>The following scilab script takes 0.07s per point:</p>
<p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">scilab</span> <span class="pre">-nb</span> <span class="pre">-nwni</span> <span class="pre">-f</span> <span class="pre">code.sce</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">code</span><span class="o">.</span><span class="n">sce</span>
<span class="n">exec</span><span class="p">(</span><span class="s2">&quot;input.data&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span><span class="p">;</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">mopen</span><span class="p">(</span><span class="s2">&quot;result.data&quot;</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">);</span>
<span class="n">mfprintf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;y = </span><span class="si">%.20e</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
<span class="n">file</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
<span class="n">quit</span>
</pre></div>
</div>
</li>
<li><p>Conversion to Python of the scilab script. It takes now 0.00001s per
point:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_exec</span><span class="p">(</span> <span class="n">X</span> <span class="p">):</span>
    <span class="k">return</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">PythonFunction</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">_exec</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
<p>If you still need to launch tiny external process, slow overhead and
parallel ability are the important factors of the wrapper. Comparison of
the differents wrapper compute time with a sample of size 1000 and an
external code that last 0.07s per point on a 8 cores computer:</p>
<ul>
<li><p>PythonFunction overhead is really slow (0.000004s) but can not launch
the _exec function in parallel.</p>
<p><img class="math" src="../_images/math/d85b8665d3aa5e4d0bf3cf32c9e0c41d8d21d695.svg" alt="(0.000004+0.07)*1000 =&gt; 70s"/></p>
</li>
<li><p>DistributedPythonFunction overhead is near 0.05s and can launch
external program in parallel.</p>
<p><img class="math" src="../_images/math/8afc7aa300bbd4646191dbc45279d2f4ed889448.svg" alt="(0.05+0.07)*1000 (/8core) =&gt; 15s"/></p>
</li>
<li><p>PythonFunction that reimplement the external program.</p>
<p><img class="math" src="../_images/math/26a6ce80772e30aee1ad6c22daf357d400e896ea.svg" alt="(0.00001)*1000 =&gt; 0.01s"/></p>
</li>
</ul>
</div>
</div>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="git_workflow.html" title="Git workflow"
             >next</a> |</li>
        <li class="right" >
          <a href="module_development.html" title="Module development"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">OpenTURNS 1.16rc1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../contents.html" >Contents</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="developer_guide.html" >Contribute</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Wrapper development</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2005-2020 Airbus-EDF-IMACS-ONERA-Phimeca.
      Last updated on Nov 06, 2020.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.4.0+.
    </div>
  </body>
</html>